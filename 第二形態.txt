import asyncio
import sqlite3
import datetime
import os
import random
import flet as ft

# ==========================================
# 1. ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ»å®šæ•°
# ==========================================
COLOR_BG = "#0f172a"
COLOR_CARD = "#1e293b"
COLOR_TEXT_MAIN = "#fdfbd3"
COLOR_ACCENT = "#38bdf8"

CATEGORIES = {
    "Work": {"icon": ft.Icons.WORK, "label": "ä»•äº‹"},
    "Study": {"icon": ft.Icons.AUTO_STORIES, "label": "å­¦ç¿’"},
    "Chores": {"icon": ft.Icons.CLEANING_SERVICES, "label": "å®¶äº‹"},
    "Wellness": {"icon": ft.Icons.SELF_IMPROVEMENT, "label": "ä¼‘æ†©ãƒ»å¥åº·"},
    "Creative": {"icon": ft.Icons.BRUSH, "label": "å‰µä½œ"},
}

DIFFICULTY_MAP = {
    "Easy": {"min": 10, "points": 10},
    "Normal": {"min": 25, "points": 30},
    "Hard": {"min": 50, "points": 60}
}

BADGE_DATA = {
    "Lyra":      {"name": "ç´åº§ (Lyra)",      "icon": "badge_lyra.png",      "msg": "çŸ¥æµã®æ˜ŸãŒè¼ãã¾ã—ãŸ",     "condition": "ã‚«ãƒ†ã‚´ãƒªã€Œå­¦ç¿’ã€ã‚’5å›å®Œäº†"},
    "Capricorn": {"name": "å±±ç¾Šåº§ (Capricorn)", "icon": "badge_capricorn.png", "msg": "ç©ã¿ä¸Šã’ãŸåŠªåŠ›ã®è¨¼ã§ã™",     "condition": "ã‚«ãƒ†ã‚´ãƒªã€Œä»•äº‹ã€ã‚’5å›å®Œäº†"},
    "Virgo":     {"name": "ä¹™å¥³åº§ (Virgo)",     "icon": "badge_virgo.png",     "msg": "æ•´ã£ãŸç”Ÿæ´»ã¸ã®ç¥ç¦ã§ã™",     "condition": "ã‚«ãƒ†ã‚´ãƒªã€Œå®¶äº‹ã€ã‚’5å›å®Œäº†"},
    "Pisces":    {"name": "é­šåº§ (Pisces)",      "icon": "badge_pisces.png",      "msg": "å‰µé€ ã®æµ·ã‚’æ³³ãåˆ‡ã‚Šã¾ã—ãŸ",   "condition": "ã‚«ãƒ†ã‚´ãƒªã€Œå‰µä½œã€ã‚’5å›å®Œäº†"},
    "Orion":     {"name": "ã‚ªãƒªã‚ªãƒ³åº§ (Orion)",  "icon": "badge_orion.png",     "msg": "å›°é›£ã‚’ç‹©ã‚‹å¼·ã•ã‚’ç§°ãˆã¾ã™",   "condition": "é›£æ˜“åº¦ã€ŒHardã€ã‚’ã‚¯ãƒªã‚¢"},
    "Polaris":   {"name": "åŒ—æ¥µæ˜Ÿ (Polaris)",    "icon": "badge_polaris.png",     "msg": "ä¸å‹•ã®é“æ¨™ã€1000Ptåˆ°é”",   "condition": "åˆè¨ˆã‚¹ã‚³ã‚¢ 1000Pt åˆ°é”"},
}

# ==========================================
# 2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç®¡ç†
# ==========================================
class DatabaseManager:
    def __init__(self, db_name="moon_tasker.db"):
        self.conn = sqlite3.connect(db_name, check_same_thread=False)
        self.create_tables()

    def create_tables(self):
        cursor = self.conn.cursor()
        cursor.execute("""
            CREATE TABLE IF NOT EXISTS task_history (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                task_name TEXT,
                category TEXT,
                difficulty TEXT,
                points INTEGER,
                is_goal_related INTEGER DEFAULT 0,
                completed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        """)
        cursor.execute("CREATE TABLE IF NOT EXISTS user_stats (key TEXT PRIMARY KEY, value INTEGER)")
        cursor.execute("""
            CREATE TABLE IF NOT EXISTS user_badges (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                badge_code TEXT UNIQUE,
                earned_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        """)
        cursor.execute("""
            CREATE TABLE IF NOT EXISTS moon_cycles (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                theme TEXT,
                category TEXT,
                deadline DATE,
                status TEXT DEFAULT 'active',
                finish_type TEXT,
                review_stars INTEGER,
                review_comment TEXT,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                completed_at TIMESTAMP
            )
        """)
        cursor.execute("""
            CREATE TABLE IF NOT EXISTS cycle_actions (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                cycle_id INTEGER,
                content TEXT,
                is_completed INTEGER DEFAULT 0
            )
        """)
        self.conn.commit()

    def add_score(self, points):
        cursor = self.conn.cursor()
        cursor.execute("INSERT OR IGNORE INTO user_stats (key, value) VALUES ('total_score', 0)")
        cursor.execute("UPDATE user_stats SET value = value + ? WHERE key = 'total_score'", (points,))
        self.conn.commit()

    def get_total_score(self):
        cursor = self.conn.cursor()
        cursor.execute("SELECT value FROM user_stats WHERE key = 'total_score'")
        res = cursor.fetchone()
        return res[0] if res else 0

    def log_task(self, name, category, difficulty, points, is_goal):
        cursor = self.conn.cursor()
        goal_flag = 1 if is_goal else 0
        cursor.execute(
            "INSERT INTO task_history (task_name, category, difficulty, points, is_goal_related) VALUES (?, ?, ?, ?, ?)",
            (name, category, difficulty, points, goal_flag)
        )
        self.conn.commit()
    
    def get_category_count(self, category_key):
        cursor = self.conn.cursor()
        cursor.execute("SELECT COUNT(*) FROM task_history WHERE category = ?", (category_key,))
        return cursor.fetchone()[0]

    def has_badge(self, badge_code):
        cursor = self.conn.cursor()
        cursor.execute("SELECT 1 FROM user_badges WHERE badge_code = ?", (badge_code,))
        return cursor.fetchone() is not None

    def award_badge(self, badge_code):
        if self.has_badge(badge_code):
            return False
        cursor = self.conn.cursor()
        cursor.execute("INSERT INTO user_badges (badge_code) VALUES (?)", (badge_code,))
        self.conn.commit()
        return True

    def get_active_cycle(self):
        cursor = self.conn.cursor()
        cursor.execute("SELECT id, theme, category, deadline, status FROM moon_cycles WHERE status IN ('active', 'review') ORDER BY id DESC LIMIT 1")
        row = cursor.fetchone()
        if row:
            return {"id": row[0], "theme": row[1], "category": row[2], "deadline": row[3], "status": row[4]}
        return None

    def start_cycle(self, theme, category, deadline):
        cursor = self.conn.cursor()
        cursor.execute("UPDATE moon_cycles SET status = 'archived' WHERE status IN ('active', 'review')")
        cursor.execute("INSERT INTO moon_cycles (theme, category, deadline) VALUES (?, ?, ?)", (theme, category, deadline))
        self.conn.commit()

    def move_to_review(self, cycle_id, finish_type):
        cursor = self.conn.cursor()
        cursor.execute("UPDATE moon_cycles SET status = 'review', finish_type = ? WHERE id = ?", (finish_type, cycle_id))
        self.conn.commit()

    def complete_cycle(self, cycle_id, stars, comment):
        cursor = self.conn.cursor()
        cursor.execute("""
            UPDATE moon_cycles 
            SET status = 'completed', review_stars = ?, review_comment = ?, completed_at = CURRENT_TIMESTAMP 
            WHERE id = ?
        """, (stars, comment, cycle_id))
        self.conn.commit()

    def add_action(self, cycle_id, content):
        cursor = self.conn.cursor()
        cursor.execute("INSERT INTO cycle_actions (cycle_id, content) VALUES (?, ?)", (cycle_id, content))
        self.conn.commit()

    def get_actions(self, cycle_id):
        cursor = self.conn.cursor()
        cursor.execute("SELECT id, content, is_completed FROM cycle_actions WHERE cycle_id = ?", (cycle_id,))
        return [{"id": r[0], "content": r[1], "is_completed": bool(r[2])} for r in cursor.fetchall()]

    def toggle_action(self, action_id, is_completed):
        cursor = self.conn.cursor()
        val = 1 if is_completed else 0
        cursor.execute("UPDATE cycle_actions SET is_completed = ? WHERE id = ?", (val, action_id))
        self.conn.commit()

    def delete_action(self, action_id):
        cursor = self.conn.cursor()
        cursor.execute("DELETE FROM cycle_actions WHERE id = ?", (action_id,))
        self.conn.commit()

db = DatabaseManager()

# ==========================================
# 3. ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
# ==========================================
def get_moon_phase_info():
    base_date = datetime.datetime(2023, 1, 22)
    today = datetime.datetime.now()
    days_passed = (today - base_date).total_seconds() / 86400
    lunation = days_passed % 29.53
    phase_idx = int((lunation / 29.53) * 8) % 8
    
    # Pythonçš„ãªæ­£ã—ã„æ›¸ãæ–¹ï¼ˆifæ–‡ã§å±•é–‹ï¼‰
    name, advice = ("Moon", "Focus")
    if phase_idx == 0:
        name, advice = "æ–°æœˆ (New Moon)", "è¨ˆç”»ã¨ç¨®ã¾ã: ç›®æ¨™è¨­å®šã¨ãƒªã‚»ãƒƒãƒˆã«æœ€é©"
    elif phase_idx == 1:
        name, advice = "ä¸‰æ—¥æœˆ (Waxing Crescent)", "èŠ½å¹ã: å°ã•ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’é–‹å§‹"
    elif phase_idx == 2:
        name, advice = "ä¸Šå¼¦ (First Quarter)", "å®Ÿè¡Œã¨æ¨é€²: èª²é¡Œã¸ã®é›†ä¸­çš„ãªå–ã‚Šçµ„ã¿"
    elif phase_idx == 3:
        name, advice = "åä¸‰å¤œ (Waxing Gibbous)", "åˆ†æã¨æ”¹å–„: æº€æœˆã«å‘ã‘ãŸãƒ©ã‚¹ãƒˆã‚¹ãƒ‘ãƒ¼ãƒˆ"
    elif phase_idx == 4:
        name, advice = "æº€æœˆ (Full Moon)", "é”æˆã¨æœ€å¤§åŒ–: æœ€ã‚‚å›°é›£ãªã‚¿ã‚¹ã‚¯ã®å®Œäº†"
    elif phase_idx == 5:
        name, advice = "åå…­å¤œ (Waning Gibbous)", "å…±æœ‰ã¨æ„Ÿè¬: æˆæœã®ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆ"
    elif phase_idx == 6:
        name, advice = "ä¸‹å¼¦ (Last Quarter)", "æ•´ç†ã¨å†…çœ: ä¸è¦ãªã‚¿ã‚¹ã‚¯ã®æ£šå¸ã—"
    elif phase_idx == 7:
        name, advice = "äºŒåå…­å¤œ (Waning Crescent)", "ä¼‘æ¯ã¨æº–å‚™: æ¬¡ã®ã‚µã‚¤ã‚¯ãƒ«ã¸ã®å›å¾©"
    
    return {"index": phase_idx, "name": name, "advice": advice}

def js_speak(text):
    safe_text = text.replace('"', '\\"')
    return f"""
    try {{
        var msg = new SpeechSynthesisUtterance("{safe_text}");
        msg.lang = 'ja-JP';
        window.speechSynthesis.speak(msg);
    }} catch(e) {{ console.log(e); }}
    """

class GlowingText(ft.Text):
    def __init__(self, text, size=16, color=COLOR_TEXT_MAIN, glow=True, **kwargs):
        super().__init__(**kwargs)
        self.value = text
        self.size = size
        self.color = color
        self.font_family = "Serif"
        if glow:
            self.style = ft.TextStyle(
                shadow=ft.BoxShadow(spread_radius=2, blur_radius=10, color=ft.Colors.with_opacity(0.4, color), offset=ft.Offset(0, 0))
            )

class StarFirework:
    def __init__(self, page):
        self.page = page

    async def explode(self):
        stars = []
        for _ in range(30):
            color = random.choice([ft.Colors.YELLOW, ft.Colors.CYAN, ft.Colors.PURPLE, ft.Colors.WHITE])
            left = random.randint(50, int(self.page.window.width or 800) - 50)
            top = random.randint(100, int(self.page.window.height or 600) - 100)
            size = random.randint(10, 25)
            
            star = ft.Icon(ft.Icons.STAR, color=color, size=0, opacity=1.0)
            container = ft.Container(
                content=star, 
                left=left, top=top, 
                animate=ft.Animation(1000, ft.AnimationCurve.EASE_OUT_EXPO),
                animate_opacity=ft.Animation(1000, ft.AnimationCurve.EASE_IN)
            )
            stars.append((container, star, size))

        stack = ft.Stack([s[0] for s in stars], expand=True)
        self.page.overlay.append(stack)
        self.page.update()
        
        await asyncio.sleep(0.1)
        for container, star, final_size in stars:
            star.size = final_size
            container.top -= 50
            container.opacity = 0
        self.page.update()

        await asyncio.sleep(1.2)
        self.page.overlay.remove(stack)
        self.page.update()

def get_moon_visual(idx):
    img_filename = f"moon_{idx}.png"
    full_path = f"assets/{img_filename}"
    if os.path.exists(full_path):
        return ft.Image(src=img_filename, width=80, height=80, fit=ft.ImageFit.CONTAIN)
    else:
        return ft.Container(
            content=ft.Icon(ft.Icons.NIGHTLIGHT, size=60, color="#fef08a"),
            width=80, height=80,
            alignment=ft.alignment.center,
            shadow=ft.BoxShadow(spread_radius=5, blur_radius=20, color=ft.Colors.with_opacity(0.2, "#fef08a"))
        )

# ==========================================
# 4. ãƒ¡ã‚¤ãƒ³å‡¦ç†
# ==========================================
async def main(page: ft.Page):
    page.title = "Moon Tasker"
    page.theme_mode = ft.ThemeMode.DARK
    page.bgcolor = COLOR_BG
    page.padding = 20
    page.scroll = ft.ScrollMode.AUTO

    # çŠ¶æ…‹ç®¡ç†
    state = {"is_running": False, "total_score": db.get_total_score()}
    my_tasks = []
    moon_info = get_moon_phase_info()
    firework = StarFirework(page)

    # ---------------------------------------------
    # 1. UIãƒ‘ãƒ¼ãƒ„ã®äº‹å‰å®šç¾© (ã“ã‚ŒãŒæœ€é‡è¦)
    # ã“ã‚Œã«ã‚ˆã‚Š "Undefined name" ã‚¨ãƒ©ãƒ¼ã‚’é˜²ãã¾ã™
    # ---------------------------------------------
    
    # ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ‘ãƒ¼ãƒ„
    score_display = GlowingText(f"{state['total_score']} Pt", size=20, color=COLOR_ACCENT)
    collection_btn = ft.IconButton(icon=ft.Icons.AUTO_STORIES, tooltip="æ˜Ÿåº§å›³é‘‘", icon_color=COLOR_ACCENT)
    
    header_right_col = ft.Column(
        [
            ft.Row([collection_btn, ft.Text("Star Fragments", size=10, color=ft.Colors.GREY_500)], alignment=ft.MainAxisAlignment.END),
            score_display
        ], 
        horizontal_alignment=ft.CrossAxisAlignment.END
    )

    moon_visual = get_moon_visual(moon_info["index"])
    header = ft.Row([
        ft.Row([
            moon_visual,
            ft.Column([
                GlowingText(moon_info["name"], size=20, weight=ft.FontWeight.BOLD),
                ft.Text(moon_info["advice"], size=12, color=ft.Colors.GREY_400),
            ], spacing=2)
        ]),
        header_right_col
    ], alignment=ft.MainAxisAlignment.SPACE_BETWEEN)

    # å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ãƒ‘ãƒ¼ãƒ„
    name_input = ft.TextField(label="ã‚¿ã‚¹ã‚¯å", bgcolor=COLOR_CARD, border_color=COLOR_ACCENT, color="white", expand=True, border_radius=10)
    time_input = ft.TextField(label="åˆ†", value="25", width=70, text_align=ft.TextAlign.RIGHT, bgcolor=COLOR_CARD, border_color=COLOR_ACCENT, color="white", border_radius=10, keyboard_type=ft.KeyboardType.NUMBER)
    goal_checkbox = ft.Checkbox(label="ç›®æ¨™ã«é–¢é€£", value=False, visible=False, fill_color=COLOR_ACCENT)
    
    # ãƒœã‚¿ãƒ³ã®å®šç¾©ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆã¯å¾Œã§ç´ã¥ã‘ï¼‰
    add_btn = ft.IconButton(ft.Icons.ADD_CIRCLE, icon_color=COLOR_ACCENT, icon_size=40)
    start_btn = ft.ElevatedButton("Start Journey", icon=ft.Icons.ROCKET_LAUNCH, style=ft.ButtonStyle(bgcolor=COLOR_ACCENT, color="black"), width=300, height=50)

    diff_dropdown = ft.Dropdown(
        options=[ft.dropdown.Option(k) for k in DIFFICULTY_MAP.keys()],
        value="Normal", label="é›£æ˜“åº¦", width=100, bgcolor=COLOR_CARD, border_color=COLOR_ACCENT, color="white", border_radius=10
    )
    
    cat_dropdown = ft.Dropdown(
        options=[ft.dropdown.Option(k, text=v["label"]) for k, v in CATEGORIES.items()],
        value="Work", label="ã‚«ãƒ†ã‚´ãƒª", width=100, bgcolor=COLOR_CARD, border_color=COLOR_ACCENT, color="white", border_radius=10
    )

    # ã‚¿ã‚¤ãƒãƒ¼ãƒ»ãƒªã‚¹ãƒˆãƒ‘ãƒ¼ãƒ„
    tasks_view = ft.ListView(expand=True, spacing=10, padding=0)
    timer_text = GlowingText("00:00", size=70, color=COLOR_ACCENT, visible=False)
    current_task_text = GlowingText("", size=22, visible=False)
    status_msg = ft.Text("", color=ft.Colors.GREY_400, visible=False)
    menu_btn = ft.IconButton(icon=ft.Icons.MORE_VERT, icon_color="white", icon_size=30, visible=False, tooltip="ãƒ¡ãƒ‹ãƒ¥ãƒ¼")
    
    gauge_image = ft.Image(src="moon_0.png", width=200, height=200, visible=False, gapless_playback=True)
    gauge_placeholder = ft.Icon(ft.Icons.CIRCLE, size=200, color=ft.Colors.with_opacity(0.1, "white"), visible=False)

    # ã‚µã‚¤ã‚¯ãƒ«UI
    cycle_section = ft.Container(padding=10)
    
    # æ—¥ä»˜ãƒ”ãƒƒã‚«ãƒ¼
    selected_date_text = ft.Text("æœªè¨­å®š", color=ft.Colors.GREY_400)
    date_picker = ft.DatePicker(first_date=datetime.datetime.now())
    page.overlay.append(date_picker)

    # ãƒ€ã‚¤ã‚¢ãƒ­ã‚°å…¥åŠ›æ¬„
    new_action_text = ft.TextField(label="å…·ä½“çš„ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³", autofocus=True)
    nm_theme = ft.TextField(label="ç›®æ¨™ (ä¾‹: ã‚¢ãƒ—ãƒªå®Œæˆ)", border_color=COLOR_ACCENT)
    nm_cat = ft.Dropdown(options=[ft.dropdown.Option(k, text=v["label"]) for k, v in CATEGORIES.items()], label="ãƒ¡ã‚¤ãƒ³ã‚«ãƒ†ã‚´ãƒª", border_color=COLOR_ACCENT)
    review_comment = ft.TextField(label="æŒ¯ã‚Šè¿”ã‚Šã‚³ãƒ¡ãƒ³ãƒˆ", multiline=True, min_lines=3, bgcolor=COLOR_CARD, border_color=COLOR_ACCENT)

    # å›³é‘‘UI
    collection_view = ft.GridView(height=500, runs_count=2, max_extent=160, child_aspect_ratio=0.8, spacing=10, run_spacing=10)
    collection_container = ft.Column([collection_view], expand=True, visible=False)
    close_collection_btn = ft.ElevatedButton("Close Collection", icon=ft.Icons.CLOSE, bgcolor=ft.Colors.GREY_800, color="white")

    # ------------------------------------
    # ãƒ­ã‚¸ãƒƒã‚¯å®Ÿè£…
    # ------------------------------------

    async def speak(text):
        try:
            getattr(page, "run_js")(js_speak(text))
        except Exception:
            pass
        await asyncio.sleep(1)

    # ãƒãƒƒã‚¸åˆ¤å®š
    async def check_badges(task_category, difficulty):
        new_badges = []
        if task_category == "Study" and db.get_category_count("Study") >= 5:
            if db.award_badge("Lyra"):
                new_badges.append("Lyra")
        if task_category == "Work" and db.get_category_count("Work") >= 5:
            if db.award_badge("Capricorn"):
                new_badges.append("Capricorn")
        if task_category == "Chores" and db.get_category_count("Chores") >= 5:
            if db.award_badge("Virgo"):
                new_badges.append("Virgo")
        if task_category == "Creative" and db.get_category_count("Creative") >= 5:
            if db.award_badge("Pisces"):
                new_badges.append("Pisces")
        if difficulty == "Hard":
            if db.award_badge("Orion"):
                new_badges.append("Orion")
        if db.get_total_score() >= 1000:
            if db.award_badge("Polaris"):
                new_badges.append("Polaris")

        if new_badges:
            for code in new_badges:
                b_data = BADGE_DATA.get(code, {})
                snack = ft.SnackBar(
                    content=ft.Row([
                        ft.Icon(ft.Icons.AUTO_AWESOME, color="yellow"),
                        ft.Text(f"ç§°å·ç²å¾—: {b_data.get('name')}\n{b_data.get('msg')}", color="white")
                    ]), 
                    bgcolor="#334155"
                )
                page.open(snack)
                await speak(f"ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ã€‚{b_data.get('name')}ã‚’ç²å¾—ã—ã¾ã—ãŸ")
            page.update()
            await firework.explode()

    # ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
    def difficulty_changed(e):
        if diff_dropdown.value in DIFFICULTY_MAP:
            time_input.value = str(DIFFICULTY_MAP[diff_dropdown.value]["min"])
            time_input.update()
    diff_dropdown.on_change = difficulty_changed

    def update_date_label(e):
        if date_picker.value:
            selected_date_text.value = date_picker.value.strftime("%Y-%m-%d")
            selected_date_text.update()
    date_picker.on_change = update_date_label

    def copy_action_to_input(text):
        name_input.value = text
        name_input.update()
        page.open(ft.SnackBar(ft.Text("ã‚¿ã‚¹ã‚¯æ¬„ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"), bgcolor=COLOR_ACCENT))

    # --- ãƒ€ã‚¤ã‚¢ãƒ­ã‚°å®šç¾© ---
    
    # 1. ã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¿½åŠ 
    def add_action_submit(e):
        cycle = db.get_active_cycle()
        if cycle and new_action_text.value:
            db.add_action(cycle['id'], new_action_text.value)
            new_action_text.value = ""
            page.close(add_action_dlg)
            update_cycle_view()
            
    add_action_dlg = ft.AlertDialog(
        title=ft.Text("ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ "),
        content=new_action_text,
        actions=[
            ft.TextButton("ã‚­ãƒ£ãƒ³ã‚»ãƒ«", on_click=lambda e: page.close(add_action_dlg)),
            ft.ElevatedButton("è¿½åŠ ", on_click=add_action_submit, bgcolor=COLOR_ACCENT, color="black")
        ],
        bgcolor=COLOR_CARD
    )

    # 2. æ–°æœˆè¨­å®š
    def start_new_moon(e):
        if not nm_theme.value or not nm_cat.value or not date_picker.value:
            return
        deadline_str = date_picker.value.strftime("%Y-%m-%d")
        db.start_cycle(nm_theme.value, nm_cat.value, deadline_str)
        page.close(new_moon_dlg)
        update_cycle_view()
        page.open(ft.SnackBar(ft.Text("æ–°æœˆã®èª“ã„ãŒè¨˜éŒ²ã•ã‚Œã¾ã—ãŸ"), bgcolor=COLOR_ACCENT))
        page.update()

    new_moon_dlg = ft.AlertDialog(
        title=ft.Text("ğŸŒ‘ æ–°æœˆã®èª“ã„"),
        content=ft.Column([
            ft.Text("ã“ã®ã‚µã‚¤ã‚¯ãƒ«ã§æˆã—é‚ã’ãŸã„ã“ã¨ã‚’è¨€èªåŒ–ã—ã¾ã—ã‚‡ã†ã€‚"), 
            nm_theme, nm_cat,
            ft.Text("æœŸé™è¨­å®š:", size=12, color=ft.Colors.GREY_400),
            ft.Row([
                # è¡Œã®æœ€å¾Œã« # type: ignore ã‚’ã¤ã‘ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ãŒæ¶ˆãˆã¾ã™
                ft.ElevatedButton("æ—¥ä»˜ã‚’é¸æŠ", icon=ft.Icons.CALENDAR_MONTH, on_click=lambda _: date_picker.pick_date()), # type: ignore
                selected_date_text
            ])
            
        ], tight=True),
        actions=[
            ft.TextButton("ã‚­ãƒ£ãƒ³ã‚»ãƒ«", on_click=lambda e: page.close(new_moon_dlg)),
            ft.ElevatedButton("èª“ã„ã‚’ç«‹ã¦ã‚‹", on_click=start_new_moon, bgcolor=COLOR_ACCENT, color="black")
        ],
        bgcolor=COLOR_CARD
    )

    def open_new_moon_dlg(e):
        nm_theme.value = ""
        nm_cat.value = "Work"
        selected_date_text.value = "æœªè¨­å®š"
        date_picker.value = None
        page.open(new_moon_dlg)

    # 3. æŒ¯ã‚Šè¿”ã‚Š
    selected_stars_value = [0]
    star_buttons = []

    def set_stars(score):
        selected_stars_value[0] = score
        for i, btn in enumerate(star_buttons):
            if i < score:
                btn.icon = ft.Icons.STAR
                btn.icon_color = "yellow"
            else:
                btn.icon = ft.Icons.STAR_BORDER
                btn.icon_color = "grey"
            btn.update()

    for i in range(1, 6):
        btn = ft.IconButton(ft.Icons.STAR_BORDER, icon_color="grey", on_click=lambda e, s=i: set_stars(s))
        star_buttons.append(btn)
    star_row = ft.Row(controls=star_buttons)

    def submit_review(e):
        cycle = db.get_active_cycle()
        if cycle:
            db.complete_cycle(cycle['id'], selected_stars_value[0], review_comment.value)
            page.close(finish_cycle_dlg)
            page.open(ft.SnackBar(ft.Text("ã‚µã‚¤ã‚¯ãƒ«å®Œäº†ã€‚ãŠç–²ã‚Œæ§˜ã§ã—ãŸã€‚"), bgcolor=COLOR_ACCENT))
            update_cycle_view()

    finish_cycle_dlg = ft.AlertDialog(
        title=ft.Text("ğŸŒ– åå…­å¤œã®æŒ¯ã‚Šè¿”ã‚Š"),
        content=ft.Column([
            ft.Text("ä»Šå›ã®ã‚µã‚¤ã‚¯ãƒ«ã¯ã„ã‹ãŒã§ã—ãŸã‹ï¼Ÿ", size=14),
            ft.Text("è©•ä¾¡:", weight=ft.FontWeight.BOLD, color=COLOR_ACCENT),
            star_row,
            review_comment
        ], tight=True),
        actions=[
            ft.ElevatedButton("è¨˜éŒ²ã—ã¦å®Œäº†", on_click=submit_review, bgcolor=COLOR_ACCENT, color="black")
        ],
        bgcolor=COLOR_CARD
    )

    def trigger_review(finish_type):
        cycle = db.get_active_cycle()
        if cycle:
            db.move_to_review(cycle['id'], finish_type)
            # ä¿®æ­£: bottom_sheet ã§ã¯ãªã open/close ç®¡ç†
            if settings_bs in page.overlay:
                page.close(settings_bs)
            update_cycle_view()

    # è¨­å®šãƒ¡ãƒ‹ãƒ¥ãƒ¼ (BottomSheet)
    settings_bs = ft.BottomSheet(
        ft.Container(
            ft.Column(
                [
                    ft.Text("ç›®æ¨™è¨­å®šãƒ¡ãƒ‹ãƒ¥ãƒ¼", size=16, weight=ft.FontWeight.BOLD, color=COLOR_ACCENT),
                    ft.ListTile(leading=ft.Icon(ft.Icons.CHECK_CIRCLE, color="green"), title=ft.Text("æ—©æœŸé”æˆ (Completed)"), subtitle=ft.Text("äºˆå®šã‚ˆã‚Šæ—©ãå®Œäº†ã—ã¾ã—ãŸ"), on_click=lambda e: trigger_review("early")),
                    ft.ListTile(leading=ft.Icon(ft.Icons.REMOVE_CIRCLE, color="red"), title=ft.Text("æ–­å¿µãƒ»ç ´æ£„ (Dropped)"), subtitle=ft.Text("ã“ã®ç›®æ¨™ã‚’å–ã‚Šä¸‹ã’ã¾ã™"), on_click=lambda e: trigger_review("dropped")),
                    ft.ListTile(leading=ft.Icon(ft.Icons.CLOSE), title=ft.Text("é–‰ã˜ã‚‹"), on_click=lambda e: page.close(settings_bs))
                ], tight=True
            ), padding=20, bgcolor=COLOR_CARD
        )
    )

    def open_settings_menu(e):
        page.open(settings_bs)

    # --- ã‚µã‚¤ã‚¯ãƒ«ç®¡ç†ãƒ»è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯ ---
    def update_cycle_view():
        cycle = db.get_active_cycle()
        cycle_section.content = None
        
        if cycle:
            # æœŸé™ãƒã‚§ãƒƒã‚¯
            today = datetime.date.today()
            deadline_date = datetime.date.fromisoformat(cycle['deadline'])
            days_left = (deadline_date - today).days

            if cycle['status'] == 'active' and days_left < 0:
                db.move_to_review(cycle['id'], "expired")
                cycle['status'] = 'review'

            if cycle['status'] == 'review':
                goal_checkbox.visible = False
                
                def open_review_dlg(e):
                    set_stars(0)
                    review_comment.value = ""
                    page.open(finish_cycle_dlg)

                cycle_section.content = ft.Container(
                    content=ft.Column([
                        ft.Text("ğŸŒ– åå…­å¤œ (Review Phase)", color="yellow", weight=ft.FontWeight.BOLD),
                        ft.Text(f"ç›®æ¨™ã€Œ{cycle['theme']}ã€ã®æœŸé–“ãŒçµ‚äº†ã—ã¾ã—ãŸã€‚", size=14),
                        ft.Text("ã“ã®ã‚µã‚¤ã‚¯ãƒ«ã®æˆæœã¨åçœã‚’è¨˜éŒ²ã—ã¾ã—ã‚‡ã†ã€‚", size=12, color=ft.Colors.GREY_400),
                        ft.ElevatedButton("æŒ¯ã‚Šè¿”ã‚Šã‚’å…¥åŠ›ã™ã‚‹", icon=ft.Icons.RATE_REVIEW, bgcolor=COLOR_ACCENT, color="black", on_click=open_review_dlg)
                    ], horizontal_alignment=ft.CrossAxisAlignment.CENTER, spacing=10),
                    bgcolor="#1e293b", border=ft.border.all(1, "yellow"),
                    border_radius=10, padding=20
                )

            elif cycle['status'] == 'active':
                goal_checkbox.visible = True
                # ä¿®æ­£: f ã‚’å‰Šé™¤ã—ã¾ã—ãŸ
                goal_checkbox.label = "ç›®æ¨™ã«é–¢é€£"
                
                days_color = "white"
                if days_left <= 3:
                    days_color = "red"
                elif days_left <= 7:
                    days_color = "orange"

                actions = db.get_actions(cycle['id'])
                action_controls = []
                for act in actions:
                    def make_check_handler(aid):
                        return lambda e: db.toggle_action(aid, e.control.value)
                    
                    def make_copy_handler(txt):
                        return lambda e: copy_action_to_input(txt)
                        
                    def make_delete_handler(aid):
                        return lambda e: [db.delete_action(aid), update_cycle_view()]

                    row = ft.Row([
                        ft.Checkbox(value=act['is_completed'], on_change=make_check_handler(act['id']), fill_color=COLOR_ACCENT),
                        ft.Text(act['content'], expand=True, size=14),
                        ft.IconButton(ft.Icons.NORTH_WEST, icon_color=COLOR_ACCENT, tooltip="ã‚¿ã‚¹ã‚¯æ¬„ã¸ã‚³ãƒ”ãƒ¼", on_click=make_copy_handler(act['content']), icon_size=16),
                        ft.IconButton(ft.Icons.DELETE_OUTLINE, icon_color=ft.Colors.GREY_500, tooltip="å‰Šé™¤", on_click=make_delete_handler(act['id']), icon_size=16)
                    ], alignment=ft.MainAxisAlignment.START)
                    action_controls.append(row)

                if not action_controls: 
                    action_view = ft.Text("å…·ä½“çš„ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç™»éŒ²ã—ã¾ã—ã‚‡ã†", size=12, color=ft.Colors.GREY_500)
                else: 
                    action_view = ft.Column(action_controls, spacing=5)

                card_content = ft.Column([
                    ft.Row([
                        ft.Icon(ft.Icons.NIGHTLIGHT_ROUND, color="yellow", size=24),
                        ft.Column([
                            ft.Text(f"æ®‹ã‚Š {days_left} æ—¥", size=12, color=days_color, weight=ft.FontWeight.BOLD),
                            ft.Text(cycle['theme'], size=16, weight=ft.FontWeight.BOLD),
                        ], expand=True),
                        ft.IconButton(ft.Icons.SETTINGS, icon_color=ft.Colors.GREY_500, tooltip="è¨­å®šãƒ»å®Œäº†", on_click=lambda e: open_settings_menu(e))
                    ]),
                    ft.Divider(color=ft.Colors.GREY_800, height=10),
                    ft.Text("ğŸŒ™ ACTIONS", size=10, color=ft.Colors.GREY_400),
                    action_view,
                    ft.Container(ft.TextButton("+ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ", icon=ft.Icons.ADD, on_click=lambda e: page.open(add_action_dlg), style=ft.ButtonStyle(color=COLOR_ACCENT)), alignment=ft.alignment.center_right)
                ])
                cycle_section.content = ft.Container(content=card_content, bgcolor="#1e293b", border=ft.border.all(1, "yellow"), border_radius=10, padding=15, shadow=ft.BoxShadow(spread_radius=1, blur_radius=10, color=ft.Colors.with_opacity(0.1, "yellow")))
        
        else:
            goal_checkbox.visible = False
            goal_checkbox.value = False
            btn = ft.ElevatedButton("æ–°æœˆã®èª“ã„ã‚’ç«‹ã¦ã‚‹", icon=ft.Icons.EDIT, style=ft.ButtonStyle(bgcolor=ft.Colors.TRANSPARENT, color=COLOR_TEXT_MAIN, side=ft.BorderSide(1, COLOR_ACCENT)), on_click=lambda e: open_new_moon_dlg(e), width=300)
            cycle_section.content = ft.Column([ft.Text("é•·æœŸçš„ãªãƒªã‚ºãƒ ã‚’å§‹ã‚ã¾ã›ã‚“ã‹ï¼Ÿ", size=12, color=ft.Colors.GREY_500), btn], horizontal_alignment=ft.CrossAxisAlignment.CENTER, spacing=10)
        
        page.update()

    # --- ã‚¿ã‚¹ã‚¯æ“ä½œ ---
    def add_task(e):
        if not name_input.value or not time_input.value:
            return
        try:
            mins = float(time_input.value)
        except ValueError:
            return
        
        # ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®å€¤ã‚’å–å¾—ï¼ˆNoneã®å ´åˆã¯Falseæ‰±ã„ã«ã™ã‚‹ï¼‰
        is_goal = goal_checkbox.value if goal_checkbox.value is not None else False

        my_tasks.append({
            "name": name_input.value,
            "category": cat_dropdown.value,
            "difficulty": diff_dropdown.value,
            "minutes": mins,
            "is_goal": is_goal
        })
        
        # ãƒã‚§ãƒƒã‚¯ã‚’å¤–ã™å‡¦ç†
        if goal_checkbox.visible:
            goal_checkbox.value = False # type: ignore
            goal_checkbox.update()
            
        name_input.value = ""
        refresh_list()
        page.update()

    # ã“ã“ã§ãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç´ã¥ã‘
    add_btn.on_click = add_task

    def refresh_list():
        tasks_view.controls.clear()
        for task in my_tasks:
            cat_key = task['category']
            c = CATEGORIES.get(cat_key, {})
            d = task['difficulty']
            goal_mark = "â˜… " if task.get('is_goal') else ""
            card = ft.Container(
                content=ft.Row([
                    ft.Icon(c.get("icon", ft.Icons.CIRCLE), color=COLOR_ACCENT, size=20),
                    ft.Column([
                        ft.Text(goal_mark + task["name"], weight=ft.FontWeight.BOLD, color="white"),
                        ft.Text(f"{c.get('label')} | {d} | {task['minutes']} min", size=12, color=ft.Colors.GREY_500)
                    ], expand=True),
                    ft.IconButton(ft.Icons.CLOSE, icon_color="red", data=task, on_click=delete_task)
                ]),
                bgcolor=COLOR_CARD, padding=15, border_radius=10, border=ft.border.all(1, ft.Colors.with_opacity(0.1, "white"))
            )
            tasks_view.controls.append(card)
        page.update()

    def delete_task(e):
        if e.control.data in my_tasks:
            my_tasks.remove(e.control.data)
        refresh_list()

    def reset_view():
        state["is_running"] = False
        input_col.visible = True
        tasks_view.visible = True
        start_btn.visible = True
        cycle_section.visible = True
        collection_btn.visible = True
        collection_btn.update()
        
        timer_text.visible = False
        current_task_text.visible = False
        status_msg.visible = False
        menu_btn.visible = False
        gauge_image.visible = False
        gauge_placeholder.visible = False
        try:
            header_right_col.controls.remove(menu_btn)
        except Exception:
            pass
        page.update()

    async def run_playlist(e):
        if not my_tasks:
            return
        state["is_running"] = True
        
        timer_text.value = "00:00"
        current_task_text.value = "Ready..."
        status_msg.value = "Initializing..."
        
        if os.path.exists("assets/moon_0.png"):
            gauge_image.src = "moon_0.png"
            gauge_image.visible = True
            gauge_placeholder.visible = False
        else:
            gauge_image.visible = False
            gauge_placeholder.visible = True
        gauge_image.update()

        input_col.visible = False
        tasks_view.visible = False
        start_btn.visible = False
        cycle_section.visible = False
        collection_btn.visible = False
        collection_btn.update()
        
        timer_text.visible = True
        current_task_text.visible = True
        status_msg.visible = True
        menu_btn.visible = True
        header_right_col.controls.append(menu_btn)
        page.update()

        for task in my_tasks:
            if not state["is_running"]:
                break
            
            name = task["name"]
            mins = task["minutes"]
            total_sec = int(mins * 60)
            
            current_task_text.value = name
            status_msg.value = "Focusing under the moonlight..."
            current_task_text.update()
            status_msg.update()
            
            await speak(f"{name}ã€é–‹å§‹")

            for k in range(total_sec, -1, -1):
                if not state["is_running"]:
                    break
                
                m, s = divmod(k, 60)
                timer_text.value = f"{m:02}:{s:02}"
                progress = (total_sec - k) / total_sec if total_sec > 0 else 1.0
                moon_idx = int(progress * 4)
                if moon_idx > 4:
                    moon_idx = 4
                
                if gauge_image.visible:
                    new_src = f"moon_{moon_idx}.png"
                    if gauge_image.src != new_src:
                        gauge_image.src = new_src
                        gauge_image.update()
                
                timer_text.update()
                await asyncio.sleep(1)

            if state["is_running"]:
                pts = DIFFICULTY_MAP.get(task["difficulty"], {"points":10})["points"]
                db.add_score(pts)
                db.log_task(name, task['category'], task['difficulty'], pts, task.get('is_goal', False))
                state["total_score"] = db.get_total_score()
                score_display.value = f"{state['total_score']} Pt"
                score_display.update()
                
                if gauge_image.visible:
                    gauge_image.src = "moon_4.png"
                    gauge_image.update()
                
                await speak(f"å®Œäº†ã€‚{pts}ãƒã‚¤ãƒ³ãƒˆç²å¾—")
                await check_badges(task['category'], task['difficulty'])
                await asyncio.sleep(1.5)

        if state["is_running"]:
            status_msg.value = "All Tasks Completed"
            status_msg.update()
            await speak("å…¨ã‚¿ã‚¹ã‚¯çµ‚äº†ã€‚")
            await asyncio.sleep(3)
            reset_view()

    # ã‚¿ã‚¤ãƒãƒ¼å®Ÿè¡Œã‚¤ãƒ™ãƒ³ãƒˆ
    start_btn.on_click = run_playlist

    # --- ä¸­æ–­ãƒ»è­¦å‘Š ---
    def close_dlg(e):
        page.close(dlg)

    def confirm_abort_phase1(e):
        # ä¿®æ­£: .value ã¸ã®ä»£å…¥ã§ã¯ãªãã€ft.Text è‡ªä½“ã‚’æ–°ã—ãä»£å…¥ã™ã‚‹
        dlg.title = ft.Text("æœ€çµ‚ç¢ºèª") 
        
        dlg.content = ft.Text("æœ¬å½“ã«ä¸­æ–­ã—ã¾ã™ã‹ï¼Ÿ\nã“ã“ã§æ­¢ã‚ã‚‹ã¨ã€ç©ã¿ä¸Šã’ãŸé›†ä¸­ãŒé€”åˆ‡ã‚Œã¦ã—ã¾ã„ã¾ã™ã€‚\nã‚ã¨å°‘ã—ã ã‘é ‘å¼µã‚Šã¾ã›ã‚“ã‹ï¼Ÿ")
        dlg.actions.clear()
        dlg.actions.extend([
            ft.TextButton("æ€ã„ã¨ã©ã¾ã‚‹", on_click=close_dlg, style=ft.ButtonStyle(color=ft.Colors.GREEN)),
            ft.TextButton("ãã‚Œã§ã‚‚ä¸­æ–­", on_click=confirm_abort_final, style=ft.ButtonStyle(color=ft.Colors.RED))
        ])
        dlg.update()

    def confirm_abort_final(e):
        state["is_running"] = False
        page.close(dlg)
        reset_view()
        
        # ä¿®æ­£: ã“ã“ã‚‚åŒæ§˜ã« ft.Text ã‚’æ–°ã—ãä»£å…¥ã™ã‚‹
        dlg.title = ft.Text("ä¸­æ–­ã®ç¢ºèª")
        
        dlg.content = ft.Text("ç¾åœ¨ã®ä½œæ¥­ã‚’ä¸­æ–­ã—ã¾ã™ã‹ï¼Ÿ")
        dlg.actions.clear()
        dlg.actions.extend([
            ft.TextButton("ã„ã„ãˆ", on_click=close_dlg),
            ft.TextButton("ä¸­æ–­ã™ã‚‹", on_click=confirm_abort_phase1, style=ft.ButtonStyle(color="red"))
        ])
        # æ³¨æ„: ã“ã“ã§ dlg.update() ã¯ä¸è¦ã§ã™ï¼ˆpage.closeã—ã¦ã„ã‚‹ãŸã‚æ¬¡å›è¡¨ç¤ºæ™‚ã«åæ˜ ã•ã‚Œã‚‹ã€ã¾ãŸã¯openæ™‚ã«å†æ§‹ç¯‰ã•ã‚Œã‚‹ãŸã‚ï¼‰

    dlg = ft.AlertDialog(
        title=ft.Text("ä¸­æ–­ã®ç¢ºèª"),
        content=ft.Text("ç¾åœ¨ã®ä½œæ¥­ã‚’ä¸­æ–­ã—ã¾ã™ã‹ï¼Ÿ"),
        actions=[
            ft.TextButton("ã„ã„ãˆ", on_click=close_dlg),
            ft.TextButton("ä¸­æ–­ã™ã‚‹", on_click=confirm_abort_phase1, style=ft.ButtonStyle(color="red"))
        ]
    )
    menu_btn.on_click = lambda e: page.open(dlg)

    # --- å›³é‘‘è¡¨ç¤º ---
    def show_badge_detail(code):
        data = BADGE_DATA[code]
        has_badge = db.has_badge(code)
        
        if has_badge:
            dlg_title = data["name"]
            dlg_content = ft.Column([
                ft.Image(src=data["icon"], width=100, height=100, fit=ft.ImageFit.CONTAIN),
                ft.Text(data["msg"], text_align=ft.TextAlign.CENTER, size=16),
                ft.Container(
                    content=ft.Text("ACQUIRED", color="black", size=12, weight=ft.FontWeight.BOLD),
                    bgcolor=COLOR_ACCENT, padding=5, border_radius=5, margin=10
                )
            ], tight=True, horizontal_alignment=ft.CrossAxisAlignment.CENTER)
        else:
            dlg_title = "???"
            condition_text = data.get("condition", "æ¡ä»¶ä¸æ˜")
            dlg_content = ft.Column([
                ft.Icon(ft.Icons.LOCK, size=60, color=ft.Colors.GREY_500),
                ft.Text("æœªè§£æ”¾ã®æ˜Ÿåº§", color=ft.Colors.GREY_400),
                ft.Divider(color=ft.Colors.GREY_800),
                ft.Text("ã€è§£æ”¾æ¡ä»¶ã€‘", weight=ft.FontWeight.BOLD, color=COLOR_ACCENT),
                ft.Text(condition_text, text_align=ft.TextAlign.CENTER)
            ], tight=True, horizontal_alignment=ft.CrossAxisAlignment.CENTER)

        detail_dlg = ft.AlertDialog(
            title=ft.Text(dlg_title, text_align=ft.TextAlign.CENTER),
            content=dlg_content,
            actions=[ft.TextButton("Close", on_click=lambda e: page.close(detail_dlg))],
            actions_alignment=ft.MainAxisAlignment.CENTER,
            bgcolor=COLOR_CARD
        )
        page.open(detail_dlg)

    def update_collection():
        collection_view.controls.clear()
        for code, data in BADGE_DATA.items():
            has_badge = db.has_badge(code)
            if has_badge:
                icon_content = ft.Image(src=data["icon"], width=60, height=60, fit=ft.ImageFit.CONTAIN, color_blend_mode=ft.BlendMode.DST)
                title_text, desc_text = data["name"], "Tap for detail"
                opacity, bg_col, bd_col = 1.0, COLOR_CARD, COLOR_ACCENT
            else:
                icon_content = ft.Icon(ft.Icons.LOCK, size=40, color=ft.Colors.GREY_400)
                title_text, desc_text = "???", "Tap for hint"
                opacity, bg_col, bd_col = 0.5, "#0f172a", ft.Colors.GREY_800
            
            item = ft.Container(
                content=ft.Column([
                    ft.Container(content=icon_content, height=60, alignment=ft.alignment.center),
                    ft.Text(title_text, size=14, weight=ft.FontWeight.BOLD, text_align=ft.TextAlign.CENTER),
                    ft.Text(desc_text, size=10, color=ft.Colors.GREY_500, text_align=ft.TextAlign.CENTER),
                ], alignment=ft.MainAxisAlignment.CENTER, spacing=5),
                bgcolor=bg_col, border=ft.border.all(1, bd_col),
                border_radius=10, padding=10, opacity=opacity,
                on_click=lambda e, c=code: show_badge_detail(c)
            )
            collection_view.controls.append(item)
        collection_view.update()

    def toggle_collection(show):
        if show:
            update_collection()
            input_col.visible = False
            tasks_view.visible = False
            start_btn.visible = False
            cycle_section.visible = False
            collection_container.visible = True
            
            timer_text.visible = False
            gauge_image.visible = False
            gauge_placeholder.visible = False
            status_msg.visible = False
        else:
            input_col.visible = True
            tasks_view.visible = True
            start_btn.visible = True
            cycle_section.visible = True
            collection_container.visible = False
            
            if os.path.exists("assets/moon_0.png"):
                gauge_image.src = "moon_0.png"
                gauge_image.visible = False
                gauge_placeholder.visible = False
        page.update()

    close_collection_btn.on_click = lambda e: toggle_collection(False)
    collection_container.controls.append(ft.Container(close_collection_btn, alignment=ft.alignment.center, padding=10))
    
    collection_btn.on_click = lambda e: toggle_collection(True)

    # ==========================================
    # ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆçµ„ã¿ç«‹ã¦
    # ==========================================
    
    # 2æ®µç›®: è¨­å®šç³»ã‚’1è¡Œã«çµ±ä¸€
    # ä¿®æ­£: 1è¡Œãšã¤ã«åˆ†ã‘ã¾ã—ãŸ
    cat_dropdown.width = None
    cat_dropdown.expand = True
    
    diff_dropdown.width = None
    diff_dropdown.expand = True
    
    settings_row = ft.Row([cat_dropdown, diff_dropdown, time_input], spacing=10)
    
    # 3æ®µç›®: ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ç³»
    action_row = ft.Row([goal_checkbox, add_btn], alignment=ft.MainAxisAlignment.SPACE_BETWEEN)
    
    # å…¥åŠ›ã‚¨ãƒªã‚¢å…¨ä½“
    input_col = ft.Column([name_input, settings_row, action_row], spacing=10)

    start_btn = ft.ElevatedButton(
        "Start Journey", 
        icon=ft.Icons.ROCKET_LAUNCH, 
        style=ft.ButtonStyle(bgcolor=COLOR_ACCENT, color="black"), 
        width=300, height=50, 
        on_click=run_playlist
    )

    page.add(
        ft.Column([
            header,
            ft.Divider(color="transparent", height=10),
            cycle_section,
            collection_container,
            ft.Divider(color="transparent", height=10),
            input_col,
            ft.Divider(color="transparent", height=10),
            tasks_view,
            ft.Container(start_btn, alignment=ft.alignment.center, padding=10),
            ft.Divider(color="transparent", height=20),
            current_task_text,
            ft.Container(content=ft.Stack([gauge_placeholder, gauge_image], alignment=ft.alignment.center), alignment=ft.alignment.center, height=220),
            timer_text,
            status_msg
        ], horizontal_alignment=ft.CrossAxisAlignment.CENTER)
    )
    
    update_cycle_view()

ft.app(target=main, view=ft.AppView.WEB_BROWSER, port=8080, host="0.0.0.0", assets_dir="assets")
