{% extends 'base.html' %}

{% block title %}ç›®æ¨™ã‚µã‚¤ã‚¯ãƒ« - Moon Tasker{% endblock %}

{% block content %}
<h1 class="page-title">ç›®æ¨™ã‚µã‚¤ã‚¯ãƒ« ğŸ¯</h1>

<!-- æœˆã®æƒ…å ± -->
<div class="card flex items-center justify-center gap-4" style="padding: 16px;">
    <span style="font-size: 32px;">{{ moon_emoji }}</span>
    <span class="text-muted">ç¾åœ¨ã®æœˆ: {{ moon_phase }}</span>
</div>

{% if active_cycle %}
<!-- é€²æ—ã‚«ãƒ¼ãƒ‰ -->
<div class="card text-center">
    <h2 class="section-title">ğŸ“Š é€²æ—çŠ¶æ³</h2>
    <p class="text-muted text-sm mb-4">{{ active_cycle.cycle_start }} ï½ {{ active_cycle.cycle_end }}</p>

    <div class="flex items-center justify-center gap-2 mb-4">
        <span class="stat-value {% if progress >= 100 %}green{% elif progress >= 50 %}blue{% else %}orange{% endif %}">
            {{ completed_count }}
        </span>
        <span class="text-muted" style="font-size: 20px;">/ {{ total_count }} ã‚¿ã‚¹ã‚¯</span>
    </div>

    <div class="progress-bar" style="max-width: 400px; margin: 0 auto; height: 12px;">
        <div class="progress-bar-fill {% if progress >= 100 %}success{% elif progress >= 50 %}primary{% else %}mood-low{% endif %}"
            style="width: {{ progress }}%;"></div>
    </div>

    <p class="mt-4"
        style="{% if progress >= 100 %}color: #4caf50{% elif progress >= 50 %}color: #64b5f6{% else %}color: #ff9800{% endif %};">
        {{ '%.1f'|format(progress) }}% -
        {% if progress >= 100 %}ç›®æ¨™é”æˆï¼ ğŸ‰{% elif progress >= 50 %}é †èª¿ã«é€²è¡Œä¸­{% else %}é ‘å¼µã‚Šã¾ã—ã‚‡ã†{% endif %}
    </p>
</div>

<!-- ã‚µã‚¤ã‚¯ãƒ«ã‚¿ã‚¹ã‚¯ -->
<div class="card">
    <div class="flex justify-between items-center mb-4">
        <h2 class="section-title" style="margin-bottom: 0;">ğŸ“‹ è¨­å®šã‚¿ã‚¹ã‚¯</h2>
        <button onclick="document.getElementById('add-task-dialog').classList.remove('hidden')" class="btn btn-primary"
            style="padding: 8px 16px;">â• ã‚¿ã‚¹ã‚¯è¿½åŠ </button>
    </div>

    {% if cycle_tasks|length == 0 %}
    <p class="text-muted">ã‚¿ã‚¹ã‚¯ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
    {% else %}
    {% for task in cycle_tasks %}
    {% set is_done = task._cycle_completed if task._cycle_completed is defined else false %}
    <div class="list-item {% if is_done %}completed{% endif %}">
        <span style="{% if is_done %}color: #4caf50{% else %}color: #666{% endif %};">
            {% if is_done %}âœ…{% else %}â¬œ{% endif %}
        </span>
        <span class="title" style="{% if is_done %}text-decoration: line-through; color: #4caf50;{% endif %}">
            {{ task.title }}
        </span>
        <span class="meta">{{ task.duration }}åˆ†</span>
    </div>
    {% endfor %}
    {% endif %}

    <a href="/timer" class="btn btn-warning w-full mt-4 text-center" style="display: block;">â±ï¸ ã‚¿ã‚¤ãƒãƒ¼ã«ã‚»ãƒƒãƒˆ</a>
</div>

<!-- ç›®æ¨™å†…å®¹ -->
<div class="card">
    <h2 class="section-title">ğŸ“‹ ç›®æ¨™ï¼ˆPlanï¼‰</h2>
    <p>{{ active_cycle.goal or 'ï¼ˆç›®æ¨™æœªè¨­å®šï¼‰' }}</p>
</div>

<!-- æ“ä½œãƒœã‚¿ãƒ³ -->
<div class="flex gap-4">
    <button onclick="document.getElementById('complete-dialog').classList.remove('hidden')" class="btn btn-success"
        style="flex: 1;">âœ… ã‚µã‚¤ã‚¯ãƒ«å®Œäº†</button>
    <form action="/moon-cycle/{{ active_cycle.id }}/delete" method="post" style="display: inline;">
        <button type="submit" onclick="return confirm('ã“ã®ã‚µã‚¤ã‚¯ãƒ«ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')" class="btn btn-danger">ğŸ—‘ï¸ å‰Šé™¤</button>
    </form>
</div>

<!-- ã‚¿ã‚¹ã‚¯è¿½åŠ ãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
<div id="add-task-dialog" class="dialog-overlay hidden">
    <div class="card dialog-content" style="padding: 32px; max-width: 500px;">
        <h2 class="section-title">â• ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ </h2>
        <p class="text-muted text-sm mb-4">ã‚µã‚¤ã‚¯ãƒ«ã«è¿½åŠ ã™ã‚‹ã‚¿ã‚¹ã‚¯ã‚’é¸æŠã—ã¦ãã ã•ã„</p>

        <form action="/moon-cycle/{{ active_cycle.id }}/add-task" method="post">
            <div style="max-height: 300px; overflow-y: auto; margin-bottom: 16px;">
                {% if available_tasks|length == 0 %}
                <p class="text-muted">åˆ©ç”¨å¯èƒ½ãªã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“</p>
                {% else %}
                {% for task in available_tasks %}
                <label class="flex items-center gap-3 p-3"
                    style="background: rgba(10,10,26,0.5); border-radius: 8px; margin-bottom: 8px; cursor: pointer;">
                    <input type="checkbox" name="task_ids" value="{{ task.id }}">
                    <span style="flex: 1;">{{ task.title }}</span>
                    <span class="text-muted text-sm">{{ task.duration }}åˆ†</span>
                </label>
                {% endfor %}
                {% endif %}
            </div>

            <div class="flex gap-2">
                <button type="submit" class="btn btn-success" style="flex: 1;">è¿½åŠ </button>
                <button type="button" onclick="document.getElementById('add-task-dialog').classList.add('hidden')"
                    class="btn btn-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </form>
    </div>
</div>

<!-- å®Œäº†ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ï¼ˆPDCA Check/Actï¼‰ -->
<div id="complete-dialog" class="dialog-overlay hidden">
    <div class="card dialog-content" style="padding: 32px; max-width: 500px;">
        <h2 class="section-title">âœ… ã‚µã‚¤ã‚¯ãƒ«å®Œäº† - æŒ¯ã‚Šè¿”ã‚Š</h2>

        <form action="/moon-cycle/{{ active_cycle.id }}/complete" method="post">
            <!-- è‡ªå·±è©•ä¾¡ -->
            <div class="form-group mb-4">
                <label class="form-label">è‡ªå·±è©•ä¾¡</label>
                <div class="flex gap-2 justify-center">
                    {% for i in range(1, 6) %}
                    <label style="cursor: pointer;">
                        <input type="radio" name="self_rating" value="{{ i }}" {% if i==3 %}checked{% endif %}
                            style="display: none;">
                        <span class="text-2xl" style="opacity: 0.5;"
                            onclick="this.style.opacity='1'; this.parentElement.querySelectorAll('input')[0].checked=true;">
                            {% if i <= 3 %}â­{% else %}ğŸŒŸ{% endif %} </span>
                    </label>
                    {% endfor %}
                </div>
            </div>

            <!-- ã†ã¾ãã„ã£ãŸç‚¹ -->
            <div class="form-group mb-4">
                <label class="form-label">ğŸ’š ã†ã¾ãã„ã£ãŸç‚¹ï¼ˆCheckï¼‰</label>
                <textarea name="good_points" rows="3" placeholder="è‰¯ã‹ã£ãŸã“ã¨ã‚’æŒ¯ã‚Šè¿”ã‚Šã¾ã—ã‚‡ã†..." class="form-textarea"></textarea>
            </div>

            <!-- æ”¹å–„ãŒå¿…è¦ãªç‚¹ -->
            <div class="form-group mb-4">
                <label class="form-label">ğŸ’› æ”¹å–„ãŒå¿…è¦ãªç‚¹ï¼ˆCheckï¼‰</label>
                <textarea name="improvement_points" rows="3" placeholder="æ¬¡ã¯ã“ã†ã—ãŸã„ãª..." class="form-textarea"></textarea>
            </div>

            <!-- æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="form-group mb-4">
                <label class="form-label">ğŸš€ æ¬¡ã®ã‚µã‚¤ã‚¯ãƒ«ã§è©¦ã™ã“ã¨ï¼ˆActï¼‰</label>
                <textarea name="next_actions" rows="3" placeholder="æ¬¡ã®ã‚µã‚¤ã‚¯ãƒ«ã§å…·ä½“çš„ã«ä½•ã‚’ã™ã‚‹ï¼Ÿ" class="form-textarea"></textarea>
            </div>

            <div class="flex gap-2">
                <button type="submit" class="btn btn-success" style="flex: 1;">å®Œäº†ã™ã‚‹</button>
                <button type="button" onclick="document.getElementById('complete-dialog').classList.add('hidden')"
                    class="btn btn-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </form>
    </div>
</div>

{% else %}
<!-- æ–°è¦ã‚µã‚¤ã‚¯ãƒ«ä½œæˆ -->
<div class="card">
    <h2 class="section-title">âœ¨ æ–°ã—ã„ç›®æ¨™ã‚µã‚¤ã‚¯ãƒ«ã‚’ä½œæˆ</h2>

    <form action="/moon-cycle/create" method="post">
        <div class="flex gap-4 mb-4">
            <div class="form-group" style="flex: 1;">
                <label class="form-label">ğŸ“… é–‹å§‹æ—¥</label>
                <input type="date" name="start_date" class="form-input" style="cursor: pointer;" required>
            </div>
            <div class="form-group" style="flex: 1;">
                <label class="form-label">ğŸ çµ‚äº†æ—¥</label>
                <input type="date" name="end_date" class="form-input" style="cursor: pointer;" required>
            </div>
        </div>

        <script>
            // é–‹å§‹æ—¥ã«ä»Šæ—¥ã€çµ‚äº†æ—¥ã«1é€±é–“å¾Œã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
            const today = new Date();
            const nextWeek = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
            document.querySelector('input[name="start_date"]').valueAsDate = today;
            document.querySelector('input[name="end_date"]').valueAsDate = nextWeek;
        </script>

        <div class="form-group mb-4">
            <label class="form-label">ç›®æ¨™ã®èª¬æ˜ï¼ˆPlanï¼‰</label>
            <textarea name="goal" rows="3" placeholder="ã“ã®æœŸé–“ã§é”æˆã—ãŸã„ç›®æ¨™ã‚’å…¥åŠ›..." class="form-textarea"></textarea>
        </div>

        <p class="text-muted text-sm mb-4">â€» ã‚µã‚¤ã‚¯ãƒ«ä½œæˆå¾Œã«ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ ã§ãã¾ã™</p>

        <button type="submit" class="btn btn-success w-full">â–¶ï¸ ã‚µã‚¤ã‚¯ãƒ«ã‚’é–‹å§‹</button>
    </form>
</div>

{% if completed_cycles|length > 0 %}
<div class="card">
    <h2 class="section-title">ğŸ“š éå»ã®ã‚µã‚¤ã‚¯ãƒ«</h2>

    {% for cycle in completed_cycles %}
    <div class="list-item" style="flex-direction: column; align-items: stretch;">
        <div class="flex justify-between items-center">
            <span style="font-weight: 500;">{{ cycle.cycle_start }} ï½ {{ cycle.cycle_end }}</span>
            <span class="text-muted text-sm">
                {{ cycle.completed_task_count }}/{{ cycle.target_task_count }}
                {% if cycle.self_rating > 0 %}
                <span style="color: #ffc107; margin-left: 8px;">{{ 'â­' * cycle.self_rating }}</span>
                {% endif %}
            </span>
        </div>
        {% if cycle.goal %}
        <p class="text-muted text-sm mt-2">{{ cycle.goal[:50] }}{% if cycle.goal|length > 50 %}...{% endif %}</p>
        {% endif %}
    </div>
    {% endfor %}
</div>
{% endif %}
{% endif %}
{% endblock %}