{% extends 'base.html' %}

{% block title %}ç›®æ¨™ã‚µã‚¤ã‚¯ãƒ« - Moon Tasker{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto space-y-6">
    <h1 class="text-3xl font-bold bg-gradient-to-r from-blue-400 to-cyan-400 bg-clip-text text-transparent">
        ç›®æ¨™ã‚µã‚¤ã‚¯ãƒ« ğŸ¯
    </h1>

    <!-- æœˆã®æƒ…å ± -->
    <div class="glass-card p-4 flex items-center justify-center gap-3">
        <span class="text-3xl">{{ moon_emoji }}</span>
        <span class="text-gray-300">ç¾åœ¨ã®æœˆ: {{ moon_phase }}</span>
    </div>

    {% if active_cycle %}
    <!-- ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚µã‚¤ã‚¯ãƒ«è¡¨ç¤º -->

    <!-- é€²æ—ã‚«ãƒ¼ãƒ‰ -->
    <div class="glass-card p-6 text-center">
        <h2 class="text-lg font-bold mb-2">ğŸ“Š é€²æ—çŠ¶æ³</h2>
        <p class="text-gray-400 text-sm mb-4">{{ active_cycle.cycle_start }} ï½ {{ active_cycle.cycle_end }}</p>

        <div class="flex justify-center items-baseline gap-2 mb-4">
            <span
                class="text-5xl font-bold 
                {% if progress >= 100 %}text-green-400{% elif progress >= 50 %}text-blue-400{% else %}text-orange-400{% endif %}">
                {{ completed_count }}
            </span>
            <span class="text-gray-400 text-xl">/ {{ total_count }} ã‚¿ã‚¹ã‚¯</span>
        </div>

        <div class="w-full max-w-md mx-auto bg-surface rounded-full h-4 overflow-hidden mb-2">
            <div class="h-4 rounded-full transition-all duration-500 progress-glow
                {% if progress >= 100 %}bg-gradient-to-r from-green-400 to-green-500
                {% elif progress >= 50 %}bg-gradient-to-r from-blue-400 to-blue-500
                {% else %}bg-gradient-to-r from-orange-400 to-orange-500{% endif %}" style="width: {{ progress }}%">
            </div>
        </div>

        <p
            class="{% if progress >= 100 %}text-green-400{% elif progress >= 50 %}text-blue-400{% else %}text-orange-400{% endif %}">
            {{ '%.1f'|format(progress) }}% -
            {% if progress >= 100 %}ç›®æ¨™é”æˆï¼ ğŸ‰{% elif progress >= 50 %}é †èª¿ã«é€²è¡Œä¸­{% else %}é ‘å¼µã‚Šã¾ã—ã‚‡ã†{% endif %}
        </p>
    </div>

    <!-- ã‚µã‚¤ã‚¯ãƒ«ã‚¿ã‚¹ã‚¯ -->
    <div class="glass-card p-6">
        <h2 class="text-lg font-bold mb-4">ğŸ“‹ è¨­å®šã‚¿ã‚¹ã‚¯</h2>

        {% if cycle_tasks|length == 0 %}
        <p class="text-gray-400">ã‚¿ã‚¹ã‚¯ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
        {% else %}
        <div class="space-y-2">
            {% for task in cycle_tasks %}
            {% set is_done = task._cycle_completed if task._cycle_completed is defined else false %}
            <div
                class="flex items-center gap-3 rounded-xl p-3
                {% if is_done %}bg-green-500/10 border border-green-500/30{% else %}bg-surface/50 border border-white/5{% endif %}">
                <span class="{% if is_done %}text-green-400{% else %}text-gray-500{% endif %}">
                    {% if is_done %}âœ…{% else %}â¬œ{% endif %}
                </span>
                <span class="flex-1 {% if is_done %}line-through text-green-400{% else %}text-white{% endif %}">
                    {{ task.title }}
                </span>
                <span class="text-gray-400 text-sm">{{ task.duration }}åˆ†</span>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <a href="/timer" class="block mt-4 btn-warning text-center font-bold py-3 px-6 rounded-xl">
            â±ï¸ ã‚¿ã‚¤ãƒãƒ¼ã«ã‚»ãƒƒãƒˆ
        </a>
    </div>

    <!-- ç›®æ¨™å†…å®¹ -->
    <div class="glass-card p-6">
        <h2 class="text-lg font-bold mb-4">ğŸ“‹ ç›®æ¨™ï¼ˆPlanï¼‰</h2>
        <p class="text-gray-300">{{ active_cycle.goal or 'ï¼ˆç›®æ¨™æœªè¨­å®šï¼‰' }}</p>

        {% if active_cycle.review %}
        <h3 class="text-md font-bold mt-4 mb-2 text-gray-400">ğŸ’­ æŒ¯ã‚Šè¿”ã‚Šãƒ¡ãƒ¢</h3>
        <p class="text-gray-400">{{ active_cycle.review }}</p>
        {% endif %}
    </div>

    <!-- æ“ä½œ -->
    <div class="glass-card p-6 text-center">
        <form action="/moon-cycle/{{ active_cycle.id }}/complete" method="post" class="inline">
            <button type="submit" class="btn-primary text-white font-bold py-3 px-8 rounded-xl">
                âœ… ã‚µã‚¤ã‚¯ãƒ«å®Œäº†
            </button>
        </form>
    </div>

    {% else %}
    <!-- æ–°è¦ã‚µã‚¤ã‚¯ãƒ«ä½œæˆãƒ•ã‚©ãƒ¼ãƒ  -->
    <div class="glass-card p-6">
        <h2 class="text-xl font-bold mb-4">âœ¨ æ–°ã—ã„ç›®æ¨™ã‚µã‚¤ã‚¯ãƒ«ã‚’ä½œæˆ</h2>

        <form action="/moon-cycle/create" method="post" class="space-y-4">
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-gray-400 text-sm mb-2">é–‹å§‹æ—¥</label>
                    <input type="date" name="start_date"
                        class="w-full bg-surface border border-white/10 rounded-xl px-4 py-3 text-white">
                </div>
                <div>
                    <label class="block text-gray-400 text-sm mb-2">çµ‚äº†æ—¥</label>
                    <input type="date" name="end_date"
                        class="w-full bg-surface border border-white/10 rounded-xl px-4 py-3 text-white">
                </div>
            </div>

            <div>
                <label class="block text-gray-400 text-sm mb-2">ç›®æ¨™ã®èª¬æ˜</label>
                <textarea name="goal" rows="3" placeholder="ã“ã®æœŸé–“ã§é”æˆã—ãŸã„ç›®æ¨™ã‚’å…¥åŠ›..."
                    class="w-full bg-surface border border-white/10 rounded-xl px-4 py-3 text-white"></textarea>
            </div>

            <p class="text-gray-400 text-sm">â€» ã‚µã‚¤ã‚¯ãƒ«ä½œæˆå¾Œã«ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ ã§ãã¾ã™</p>

            <button type="submit" class="w-full btn-success text-white font-bold py-3 px-6 rounded-xl">
                â–¶ï¸ ã‚µã‚¤ã‚¯ãƒ«ã‚’é–‹å§‹
            </button>
        </form>
    </div>

    <!-- éå»ã®ã‚µã‚¤ã‚¯ãƒ« -->
    {% if completed_cycles|length > 0 %}
    <div class="glass-card p-6">
        <h2 class="text-lg font-bold mb-4">ğŸ“š éå»ã®ã‚µã‚¤ã‚¯ãƒ«</h2>

        <div class="space-y-3">
            {% for cycle in completed_cycles %}
            <div class="bg-surface/50 rounded-xl p-4 border border-white/5">
                <div class="flex justify-between items-center">
                    <span class="font-medium">{{ cycle.cycle_start }} ï½ {{ cycle.cycle_end }}</span>
                    <span class="text-gray-400 text-sm">
                        {{ cycle.completed_task_count }}/{{ cycle.target_task_count }}
                        {% if cycle.self_rating > 0 %}
                        <span class="text-yellow-400 ml-2">{{ 'â˜…' * cycle.self_rating }}{{ 'â˜†' * (5 - cycle.self_rating)
                            }}</span>
                        {% endif %}
                    </span>
                </div>
                {% if cycle.goal %}
                <p class="text-gray-400 text-sm mt-2">{{ cycle.goal[:50] }}{% if cycle.goal|length > 50 %}...{% endif %}
                </p>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    {% endif %}
</div>
{% endblock %}