{% extends 'base.html' %}

{% block title %}ç›®æ¨™ã‚µã‚¤ã‚¯ãƒ« - Moon Tasker{% endblock %}

{% block content %}
<h1 class="page-title">ç›®æ¨™ã‚µã‚¤ã‚¯ãƒ« ğŸ¯</h1>

<!-- æœˆã®æƒ…å ± -->
<div class="card flex items-center justify-center gap-4" style="padding: 16px;">
    <span style="font-size: 32px;">{{ moon_emoji }}</span>
    <span class="text-muted">ç¾åœ¨ã®æœˆ: {{ moon_phase }}</span>
</div>

{% if active_cycle %}
<!-- é€²æ—ã‚«ãƒ¼ãƒ‰ -->
<div class="card text-center">
    <h2 class="section-title">ğŸ“Š é€²æ—çŠ¶æ³</h2>
    <p class="text-muted text-sm mb-4">{{ active_cycle.cycle_start }} ï½ {{ active_cycle.cycle_end }}</p>

    <div class="flex items-center justify-center gap-2 mb-4">
        <span class="stat-value {% if progress >= 100 %}green{% elif progress >= 50 %}blue{% else %}orange{% endif %}">
            {{ completed_count }}
        </span>
        <span class="text-muted" style="font-size: 20px;">/ {{ total_count }} ã‚¿ã‚¹ã‚¯</span>
    </div>

    <div class="progress-bar" style="max-width: 400px; margin: 0 auto; height: 12px;">
        <div class="progress-bar-fill {% if progress >= 100 %}success{% elif progress >= 50 %}primary{% else %}mood-low{% endif %}"
            style="width: {{ progress }}%;"></div>
    </div>

    <p class="mt-4 {% if progress >= 100 %}text-green{% elif progress >= 50 %}text-blue{% else %}text-orange{% endif %}"
        style="{% if progress >= 100 %}color: #4caf50{% elif progress >= 50 %}color: #64b5f6{% else %}color: #ff9800{% endif %};">
        {{ '%.1f'|format(progress) }}% -
        {% if progress >= 100 %}ç›®æ¨™é”æˆï¼ ğŸ‰{% elif progress >= 50 %}é †èª¿ã«é€²è¡Œä¸­{% else %}é ‘å¼µã‚Šã¾ã—ã‚‡ã†{% endif %}
    </p>
</div>

<!-- ã‚µã‚¤ã‚¯ãƒ«ã‚¿ã‚¹ã‚¯ -->
<div class="card">
    <h2 class="section-title">ğŸ“‹ è¨­å®šã‚¿ã‚¹ã‚¯</h2>

    {% if cycle_tasks|length == 0 %}
    <p class="text-muted">ã‚¿ã‚¹ã‚¯ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
    {% else %}
    {% for task in cycle_tasks %}
    {% set is_done = task._cycle_completed if task._cycle_completed is defined else false %}
    <div class="list-item {% if is_done %}completed{% endif %}">
        <span style="{% if is_done %}color: #4caf50{% else %}color: #666{% endif %};">
            {% if is_done %}âœ…{% else %}â¬œ{% endif %}
        </span>
        <span class="title" style="{% if is_done %}text-decoration: line-through; color: #4caf50;{% endif %}">
            {{ task.title }}
        </span>
        <span class="meta">{{ task.duration }}åˆ†</span>
    </div>
    {% endfor %}
    {% endif %}

    <a href="/timer" class="btn btn-warning w-full mt-4 text-center" style="display: block;">â±ï¸ ã‚¿ã‚¤ãƒãƒ¼ã«ã‚»ãƒƒãƒˆ</a>
</div>

<!-- ç›®æ¨™å†…å®¹ -->
<div class="card">
    <h2 class="section-title">ğŸ“‹ ç›®æ¨™ï¼ˆPlanï¼‰</h2>
    <p>{{ active_cycle.goal or 'ï¼ˆç›®æ¨™æœªè¨­å®šï¼‰' }}</p>
</div>

{% else %}
<!-- æ–°è¦ã‚µã‚¤ã‚¯ãƒ«ä½œæˆ -->
<div class="card">
    <h2 class="section-title">âœ¨ æ–°ã—ã„ç›®æ¨™ã‚µã‚¤ã‚¯ãƒ«ã‚’ä½œæˆ</h2>

    <form action="/moon-cycle/create" method="post">
        <div class="form-row mb-4">
            <div class="form-group">
                <label class="form-label">é–‹å§‹æ—¥</label>
                <input type="date" name="start_date" class="form-input">
            </div>
            <div class="form-group">
                <label class="form-label">çµ‚äº†æ—¥</label>
                <input type="date" name="end_date" class="form-input">
            </div>
        </div>

        <div class="form-group mb-4">
            <label class="form-label">ç›®æ¨™ã®èª¬æ˜</label>
            <textarea name="goal" rows="3" placeholder="ã“ã®æœŸé–“ã§é”æˆã—ãŸã„ç›®æ¨™ã‚’å…¥åŠ›..." class="form-textarea"></textarea>
        </div>

        <p class="text-muted text-sm mb-4">â€» ã‚µã‚¤ã‚¯ãƒ«ä½œæˆå¾Œã«ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ ã§ãã¾ã™</p>

        <button type="submit" class="btn btn-success w-full">â–¶ï¸ ã‚µã‚¤ã‚¯ãƒ«ã‚’é–‹å§‹</button>
    </form>
</div>

{% if completed_cycles|length > 0 %}
<div class="card">
    <h2 class="section-title">ğŸ“š éå»ã®ã‚µã‚¤ã‚¯ãƒ«</h2>

    {% for cycle in completed_cycles %}
    <div class="list-item" style="flex-direction: column; align-items: stretch;">
        <div class="flex justify-between items-center">
            <span style="font-weight: 500;">{{ cycle.cycle_start }} ï½ {{ cycle.cycle_end }}</span>
            <span class="text-muted text-sm">{{ cycle.completed_task_count }}/{{ cycle.target_task_count }}</span>
        </div>
        {% if cycle.goal %}
        <p class="text-muted text-sm mt-2">{{ cycle.goal[:50] }}{% if cycle.goal|length > 50 %}...{% endif %}</p>
        {% endif %}
    </div>
    {% endfor %}
</div>
{% endif %}
{% endif %}
{% endblock %}