{% extends 'base.html' %}

{% block title %}ãƒ•ãƒ¬ãƒ³ãƒ‰ - Moon Tasker{% endblock %}

{% block content %}
<h1 class="page-title">ãƒ•ãƒ¬ãƒ³ãƒ‰ ğŸŒ™</h1>

{% if is_logged_in %}
<!-- ãƒ­ã‚°ã‚¤ãƒ³ä¸­ -->
<div class="card" style="border-left: 4px solid #4caf50;">
    <div class="flex justify-between items-center">
        <div>
            <p class="text-sm text-muted">ãƒ­ã‚°ã‚¤ãƒ³ä¸­</p>
            <p style="font-weight: 600;">{{ user_email }}</p>
        </div>
        <form action="/friends/logout" method="post">
            <button type="submit" class="btn btn-secondary" style="padding: 8px 16px;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </form>
    </div>
</div>

<!-- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚«ãƒ¼ãƒ‰ -->
<div class="card">
    <h3 class="section-title">ğŸ‘¤ ãƒã‚¤ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h3>

    <div class="flex items-center gap-4 mb-4">
        <div
            style="width: 64px; height: 64px; border-radius: 50%; background: linear-gradient(135deg, #7c4dff, #64b5f6); display: flex; align-items: center; justify-content: center;">
            <span style="font-size: 28px;">ğŸŒ™</span>
        </div>
        <div style="flex: 1;">
            <p id="nickname-display" style="font-weight: 600; font-size: 18px;">{{ user_profile.nickname if user_profile
                and
                user_profile.nickname else (user_nickname or user_email.split('@')[0]) }}</p>
            {% if user_profile and user_profile.constellation_badge %}
            <p style="color: #ffc107; font-size: 14px;">âœ¨ {{ user_profile.constellation_badge }}</p>
            {% else %}
            <p class="text-muted text-sm">ç§°å·æœªè¨­å®š</p>
            {% endif %}
        </div>
        <button onclick="toggleNicknameEdit()" class="btn btn-secondary" style="padding: 4px 12px; font-size: 12px;">âœï¸
            ç·¨é›†</button>
    </div>

    <!-- ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ  -->
    <form id="nickname-form" action="/friends/update-nickname" method="post" class="hidden mb-4"
        style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px;">
        <label class="form-label text-sm">ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å¤‰æ›´</label>
        <div class="flex gap-2">
            <input type="text" name="nickname" placeholder="æ–°ã—ã„ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ "
                value="{{ user_profile.nickname if user_profile and user_profile.nickname else (user_nickname or '') }}"
                class="form-input" style="flex: 1;" maxlength="20">
            <button type="submit" class="btn btn-success" style="padding: 8px 16px;">ä¿å­˜</button>
            <button type="button" onclick="toggleNicknameEdit()" class="btn btn-secondary"
                style="padding: 8px 12px;">âœ•</button>
        </div>
    </form>

    <!-- ç§°å·é¸æŠ -->
    {% if unlocked_badges|length > 0 %}
    <form action="/friends/update-title" method="post" class="mt-4">
        <label class="form-label text-sm">ç§°å·ã‚’é¸æŠ</label>
        <div class="flex gap-2">
            <select name="title" class="form-select" style="flex: 1;">
                <option value="">ç§°å·ãªã—</option>
                {% for badge in unlocked_badges %}
                <option value="{{ badge.title }}" {% if user_profile and user_profile.constellation_badge==badge.title
                    %}selected{% endif %}>
                    {{ badge.title }}ï¼ˆ{{ badge.constellation_name }}ï¼‰
                </option>
                {% endfor %}
            </select>
            <button type="submit" class="btn btn-primary" style="padding: 8px 16px;">è¨­å®š</button>
        </div>
    </form>
    {% else %}
    <p class="text-muted text-sm mt-4">ğŸ’¡ æ˜Ÿåº§å›³é‘‘ã§ãƒãƒƒã‚¸ã‚’ç²å¾—ã™ã‚‹ã¨ç§°å·ã‚’è¨­å®šã§ãã¾ã™</p>
    {% endif %}
</div>

<!-- ãƒã‚¤ãƒ•ãƒ¬ãƒ³ãƒ‰ã‚³ãƒ¼ãƒ‰ -->
<div class="card text-center">
    <p class="text-muted text-sm mb-2">ã‚ãªãŸã®ãƒ•ãƒ¬ãƒ³ãƒ‰ã‚³ãƒ¼ãƒ‰</p>
    <p style="font-size: 28px; font-weight: 700; font-family: monospace; letter-spacing: 0.1em; color: #ffc107;">
        {{ my_friend_code or '--------' }}
    </p>
    <p class="text-xs text-muted mt-2">å‹é”ã«ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’å…±æœ‰ã—ã‚ˆã†ï¼</p>
</div>

<!-- ç”Ÿå‘½ä½“åŒæœŸ -->
<div class="card">
    <div class="flex justify-between items-center">
        <div>
            <h3 class="section-title" style="margin-bottom: 0;">
                {% if has_local_creature %}ğŸ”„ ç”Ÿå‘½ä½“ã®åŒæœŸ{% else %}ğŸ¥š ç”Ÿå‘½ä½“ã‚’è‚²ã¦ã‚ˆã†{% endif %}
            </h3>
            <p class="text-muted text-sm">
                {% if has_local_creature %}
                ãƒ•ãƒ¬ãƒ³ãƒ‰ã«è¦‹ã›ã‚‹ãŸã‚ã«åŒæœŸã—ã‚ˆã†
                {% else %}
                ã¾ãšã¯ç”Ÿå‘½ä½“ã‚’è‚²ã¦ã¦ã¿ã‚ˆã†ï¼
                {% endif %}
            </p>
            {% if local_creature and has_local_creature %}
            <p class="text-sm mt-2" style="color: #64b5f6;">
                ç¾åœ¨: {{ local_creature.name }} (Lv.{{ local_creature.evolution_stage }})
            </p>
            {% endif %}
        </div>
        <form action="{% if has_local_creature %}/friends/sync-creature{% else %}/creature{% endif %}"
            method="{% if has_local_creature %}post{% else %}get{% endif %}">
            <button type="submit" class="btn {% if has_local_creature %}btn-primary{% else %}btn-success{% endif %}"
                style="padding: 8px 16px;">
                {% if has_local_creature %}åŒæœŸã™ã‚‹{% else %}è‚²ã¦ã‚‹{% endif %}
            </button>
        </form>
    </div>
</div>

<!-- ãƒ‡ãƒ¼ã‚¿åŒæœŸ -->
<div class="card">
    <h3 class="section-title">ğŸ“¦ ãƒ‡ãƒ¼ã‚¿åŒæœŸ</h3>
    <p class="text-muted text-sm mb-4">ã‚¿ã‚¹ã‚¯ã¨ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜ã—ã¦ã€åˆ¥ã®ç«¯æœ«ã§ã‚‚ä½¿ãˆã‚‹ã‚ˆã†ã«ã—ã¾ã™</p>

    <div id="sync-status" class="mb-4 hidden"
        style="padding: 12px; border-radius: 8px; background: rgba(76, 175, 80, 0.2);">
        <p class="text-sm text-center"></p>
    </div>

    <div class="flex gap-2">
        <button onclick="syncUpload()" class="btn btn-primary" style="flex: 1; padding: 12px;">
            â¬†ï¸ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        </button>
        <button onclick="syncDownload()" class="btn btn-secondary" style="flex: 1; padding: 12px;">
            â¬‡ï¸ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        </button>
    </div>

    <p class="text-xs text-muted mt-2 text-center">
        â¬†ï¸ ãƒ­ãƒ¼ã‚«ãƒ«â†’ã‚¯ãƒ©ã‚¦ãƒ‰ &nbsp; â¬‡ï¸ ã‚¯ãƒ©ã‚¦ãƒ‰â†’ãƒ­ãƒ¼ã‚«ãƒ«
    </p>
</div>

<script>
    async function syncUpload() {
        const status = document.getElementById('sync-status');
        status.classList.remove('hidden');
        status.querySelector('p').textContent = 'â³ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...';

        try {
            const res = await fetch('/sync/upload', { method: 'POST' });
            const data = await res.json();
            if (data.success) {
                status.querySelector('p').textContent = `âœ… ${data.tasks}å€‹ã®ã‚¿ã‚¹ã‚¯ã¨${data.playlists}å€‹ã®ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ`;
            } else {
                status.querySelector('p').textContent = `âŒ ã‚¨ãƒ©ãƒ¼: ${data.error}`;
            }
        } catch (e) {
            status.querySelector('p').textContent = 'âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼';
        }
    }

    async function syncDownload() {
        const status = document.getElementById('sync-status');
        status.classList.remove('hidden');
        status.querySelector('p').textContent = 'â³ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­...';

        try {
            const res = await fetch('/sync/download', { method: 'POST' });
            const data = await res.json();
            if (data.success) {
                status.querySelector('p').textContent = `âœ… ${data.tasks}å€‹ã®ã‚¿ã‚¹ã‚¯ã¨${data.playlists}å€‹ã®ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ`;
                setTimeout(() => location.reload(), 1500);
            } else {
                status.querySelector('p').textContent = `âŒ ã‚¨ãƒ©ãƒ¼: ${data.error}`;
            }
        } catch (e) {
            status.querySelector('p').textContent = 'âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼';
        }
    }
</script>

<!-- ãƒ•ãƒ¬ãƒ³ãƒ‰è¿½åŠ  -->
<div class="card">
    <h3 class="section-title">â• ãƒ•ãƒ¬ãƒ³ãƒ‰ã‚’è¿½åŠ </h3>
    <form action="/friends/add" method="post" class="flex gap-2">
        <input type="text" name="friend_code" placeholder="ãƒ•ãƒ¬ãƒ³ãƒ‰ã‚³ãƒ¼ãƒ‰ï¼ˆ8æ–‡å­—ï¼‰" class="form-input"
            style="flex: 1; text-transform: uppercase;" maxlength="8">
        <button type="submit" class="btn btn-success">ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡</button>
    </form>
</div>

<!-- æ‰¿èªå¾…ã¡ãƒªã‚¯ã‚¨ã‚¹ãƒˆ -->
{% if pending_requests|length > 0 %}
<div class="card">
    <h3 class="section-title">ğŸ“¥ ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªã‚¯ã‚¨ã‚¹ãƒˆ <span style="color: #ff6b9d;">({{ pending_requests|length }})</span></h3>
    {% for req in pending_requests %}
    <div class="list-item" style="margin-bottom: 8px;">
        <div style="flex: 1;">
            <span style="font-weight: 600;">{{ req.from_nickname }}</span>
            <span class="text-muted text-xs"> ã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ</span>
        </div>
        <div class="flex gap-2">
            <form action="/friends/accept/{{ req.id }}" method="post" style="display: inline;">
                <button type="submit" class="btn btn-success" style="padding: 8px 16px; font-size: 12px;">æ‰¿èª</button>
            </form>
            <form action="/friends/reject/{{ req.id }}" method="post" style="display: inline;">
                <button type="submit" class="btn btn-secondary" style="padding: 8px 16px; font-size: 12px;">æ‹’å¦</button>
            </form>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- ãƒ•ãƒ¬ãƒ³ãƒ‰ä¸€è¦§ -->
<div class="card">
    <h3 class="section-title">ğŸ‘¥ ãƒ•ãƒ¬ãƒ³ãƒ‰ä¸€è¦§</h3>

    {% if friends_list|length == 0 %}
    <div class="text-center" style="padding: 32px;">
        <span style="font-size: 48px;">ğŸŒ™</span>
        <p class="text-muted mt-4">ã¾ã ãƒ•ãƒ¬ãƒ³ãƒ‰ãŒã„ã¾ã›ã‚“</p>
        <p class="text-xs text-muted mt-2">ãƒ•ãƒ¬ãƒ³ãƒ‰ã‚³ãƒ¼ãƒ‰ã‚’äº¤æ›ã—ã¦è¿½åŠ ã—ã‚ˆã†ï¼</p>
    </div>
    {% else %}
    {% for friend in friends_list %}
    <a href="/friends/{{ friend.friend_id }}/creature" class="list-item" style="text-decoration: none; color: inherit;">
        <span style="font-size: 24px;">ğŸ°</span>
        <div style="flex: 1;">
            <p style="font-weight: 500;">{{ friend.nickname or 'ãƒ•ãƒ¬ãƒ³ãƒ‰' }}</p>
        </div>
        <span class="text-muted">â†’</span>
    </a>
    {% endfor %}
    {% endif %}
</div>

<!-- ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
<script>
    function toggleNicknameEdit() {
        const form = document.getElementById('nickname-form');
        if (form) form.classList.toggle('hidden');
    }
</script>

{% else %}
<!-- ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ  -->
<div class="card">
    <h2 class="section-title">ğŸ” ãƒ­ã‚°ã‚¤ãƒ³ / æ–°è¦ç™»éŒ²</h2>
    <p class="text-muted text-sm mb-6">
        ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã™ã‚‹ã¨ã€ãƒ•ãƒ¬ãƒ³ãƒ‰ã¨ç”Ÿå‘½ä½“ã‚’è¦‹ã›åˆãˆã¾ã™ï¼<br>
        ãƒ­ã‚°ã‚¤ãƒ³ãªã—ã§ã‚‚é€šå¸¸æ©Ÿèƒ½ã¯ä½¿ãˆã¾ã™ã€‚
    </p>

    <div id="login-error"></div>

    <!-- ãƒ­ã‚°ã‚¤ãƒ³ã‚¿ãƒ– -->
    <div class="flex gap-2 mb-4">
        <button onclick="showTab('login')" id="tab-login" class="btn btn-primary" style="flex: 1;">ãƒ­ã‚°ã‚¤ãƒ³</button>
        <button onclick="showTab('signup')" id="tab-signup" class="btn btn-secondary" style="flex: 1;">æ–°è¦ç™»éŒ²</button>
    </div>

    <!-- ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ  -->
    <form id="form-login" action="/friends/login" method="post" hx-post="/friends/login" hx-target="#login-error"
        hx-swap="innerHTML">
        <div class="form-group mb-4">
            <label class="form-label">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
            <input type="email" name="email" placeholder="example@mail.com" required class="form-input">
        </div>
        <div class="form-group mb-4">
            <label class="form-label">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
            <input type="password" name="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" required class="form-input">
        </div>
        <button type="submit" class="btn btn-success w-full">ãƒ­ã‚°ã‚¤ãƒ³</button>
    </form>

    <!-- æ–°è¦ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ  -->
    <form id="form-signup" action="/friends/signup" method="post" class="hidden" hx-post="/friends/signup"
        hx-target="#login-error" hx-swap="innerHTML">
        <div class="form-group mb-4">
            <label class="form-label">ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ï¼ˆä»»æ„ï¼‰</label>
            <input type="text" name="nickname" placeholder="è¡¨ç¤ºå" class="form-input">
        </div>
        <div class="form-group mb-4">
            <label class="form-label">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
            <input type="email" name="email" placeholder="example@mail.com" required class="form-input">
        </div>
        <div class="form-group mb-4">
            <label class="form-label">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆ6æ–‡å­—ä»¥ä¸Šï¼‰</label>
            <input type="password" name="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" minlength="6" required class="form-input">
        </div>
        <button type="submit" class="btn btn-success w-full">æ–°è¦ç™»éŒ²</button>
    </form>
</div>

<!-- ã‚²ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰èª¬æ˜ -->
<div class="card" style="background: rgba(255, 193, 7, 0.1); border-color: rgba(255, 193, 7, 0.3);">
    <h3 class="section-title" style="color: #ffc107;">ğŸ’¡ ã‚²ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã«ã¤ã„ã¦</h3>
    <p class="text-sm">
        ãƒ­ã‚°ã‚¤ãƒ³ãªã—ã§ã‚‚ã‚¢ãƒ—ãƒªã®å…¨æ©Ÿèƒ½ãŒä½¿ãˆã¾ã™ï¼<br>
        ãƒ‡ãƒ¼ã‚¿ã¯ã“ã®ç«¯æœ«ã«ã®ã¿ä¿å­˜ã•ã‚Œã¾ã™ã€‚<br><br>
        ãƒ•ãƒ¬ãƒ³ãƒ‰æ©Ÿèƒ½ã‚„ãƒ‡ãƒ¼ã‚¿ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½¿ã„ãŸã„å ´åˆã¯ã€<br>
        ä¸Šã®ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
    </p>
</div>

<script>
    function showTab(tab) {
        const loginForm = document.getElementById('form-login');
        const signupForm = document.getElementById('form-signup');
        const tabLogin = document.getElementById('tab-login');
        const tabSignup = document.getElementById('tab-signup');

        if (tab === 'login') {
            loginForm.classList.remove('hidden');
            signupForm.classList.add('hidden');
            tabLogin.className = 'btn btn-primary';
            tabSignup.className = 'btn btn-secondary';
        } else {
            loginForm.classList.add('hidden');
            signupForm.classList.remove('hidden');
            tabLogin.className = 'btn btn-secondary';
            tabSignup.className = 'btn btn-primary';
        }
    }

    function toggleNicknameEdit() {
        const form = document.getElementById('nickname-form');
        if (form) form.classList.toggle('hidden');
    }
</script>
{% endif %}
{% endblock %}