{% extends 'base.html' %}

{% block title %}ã‚¿ã‚¹ã‚¯ç®¡ç† - Moon Tasker{% endblock %}

{% block content %}
<h1 class="page-title">ã‚¿ã‚¹ã‚¯ç®¡ç† ğŸ“</h1>

<!-- ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆé¸æŠãƒ»ä½œæˆ -->
<div class="card">
    <h2 class="section-title">ğŸ“‹ ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆ</h2>

    <div class="flex gap-2 mb-4">
        <select id="playlist-select" class="form-select" style="flex: 1;"
            onchange="window.location.href='/playlist?selected=' + this.value">
            <option value="">ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚’é¸æŠ...</option>
            {% for pl in playlists %}
            <option value="{{ pl.id }}" {% if selected_id==pl.id %}selected{% endif %}>
                {{ pl.name }}
            </option>
            {% endfor %}
        </select>

        {% if selected_id %}
        <form action="/playlist/{{ selected_id }}/delete" method="post">
            <button type="submit" onclick="return confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')" class="btn btn-danger"
                style="padding: 12px;">ğŸ—‘ï¸</button>
        </form>
        {% endif %}
    </div>

    <form action="/playlist/create" method="post" class="flex gap-2">
        <input type="text" name="name" placeholder="æ–°è¦ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆå" class="form-input" style="flex: 1;">
        <button type="submit" class="btn btn-primary">â• ä½œæˆ</button>
    </form>
</div>

<!-- ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆå†…ã‚¿ã‚¹ã‚¯ -->
{% if selected_id %}
<div class="card">
    <div class="flex justify-between items-center mb-4">
        <h2 class="section-title" style="margin-bottom: 0;">ğŸ“‹ ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã®å†…å®¹</h2>
        <button onclick="document.getElementById('ai-dialog').classList.remove('hidden')" class="btn btn-primary"
            style="padding: 8px 16px;">ğŸ¤– AIæœ€é©åŒ–</button>
    </div>

    {% if selected_tasks|length == 0 %}
    <p class="text-muted">ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ä¸‹ã‹ã‚‰è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</p>
    {% else %}
    {% for task in selected_tasks %}
    <div class="list-item">
        <span class="text-muted" style="width: 24px;">{{ loop.index }}.</span>

        <!-- é †åºå¤‰æ›´ãƒœã‚¿ãƒ³ -->
        <div class="flex flex-col gap-1" style="margin-right: 8px;">
            {% if not loop.first %}
            <form action="/playlist/{{ selected_id }}/move/{{ task.id }}/up" method="post" style="display: inline;">
                <button type="submit" class="action-btn" style="font-size: 12px;">â–²</button>
            </form>
            {% endif %}
            {% if not loop.last %}
            <form action="/playlist/{{ selected_id }}/move/{{ task.id }}/down" method="post" style="display: inline;">
                <button type="submit" class="action-btn" style="font-size: 12px;">â–¼</button>
            </form>
            {% endif %}
        </div>

        <span class="title">{{ task.title }}</span>
        <span class="meta">{{ task.duration }}åˆ†</span>
        <span class="meta">{{ 'â­' * task.difficulty }}</span>
        <form action="/playlist/{{ selected_id }}/remove/{{ task.id }}" method="post" style="display: inline;">
            <button type="submit" class="action-btn" style="color: #ff9800;">âœ•</button>
        </form>
    </div>
    {% endfor %}
    {% endif %}
</div>
{% endif %}

<!-- AIæœ€é©åŒ–ãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
<div id="ai-dialog" class="dialog-overlay hidden">
    <div class="card dialog-content" style="padding: 32px;">
        <h2 class="section-title">ğŸ¤– AIæœ€é©åŒ–</h2>
        <p class="text-muted text-sm mb-6">ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã®ã‚¿ã‚¹ã‚¯é †åºã‚’AIã§æœ€é©åŒ–ã—ã¾ã™</p>

        <form action="/playlist/{{ selected_id }}/optimize" method="post" id="optimize-form">
            <div class="mb-4">
                <label class="flex items-center gap-2 mb-2">
                    <input type="radio" name="mode" value="balanced" checked>
                    <span>ãƒãƒ©ãƒ³ã‚¹æœ€é©åŒ–ï¼ˆé›£æ˜“åº¦ã‚’äº¤äº’ã«é…ç½®ï¼‰</span>
                </label>
                <label class="flex items-center gap-2 mb-2">
                    <input type="radio" name="mode" value="time_limited">
                    <span>æ™‚é–“åˆ¶é™æœ€é©åŒ–</span>
                </label>
                <div id="time-limit-input" class="hidden ml-6 mt-2">
                    <input type="number" name="time_limit" placeholder="åˆ¶é™æ™‚é–“ï¼ˆåˆ†ï¼‰" class="form-input"
                        style="width: 150px;">
                </div>
                <label class="flex items-center gap-2">
                    <input type="radio" name="mode" value="genetic">
                    <span>éºä¼çš„ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ æœ€é©åŒ–</span>
                </label>
            </div>
        </form>

        <div class="flex gap-2 mt-6">
            <button onclick="document.getElementById('optimize-form').submit()" class="btn btn-success"
                style="flex: 1;">âœ¨ æœ€é©åŒ–å®Ÿè¡Œ</button>
            <button onclick="document.getElementById('ai-dialog').classList.add('hidden')"
                class="btn btn-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>

        <hr style="border-color: rgba(255,255,255,0.1); margin: 24px 0;">

        <button
            onclick="document.getElementById('ai-dialog').classList.add('hidden'); document.getElementById('lifestyle-dialog').classList.remove('hidden');"
            class="btn btn-secondary w-full">âš™ï¸ ç”Ÿæ´»è¨­å®šã‚’é–‹ã</button>
    </div>
</div>

<!-- ç”Ÿæ´»è¨­å®šãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
<div id="lifestyle-dialog" class="dialog-overlay hidden">
    <div class="card dialog-content" style="padding: 32px; max-width: 500px;">
        <h2 class="section-title">âš™ï¸ ç”Ÿæ´»æ™‚é–“è¨­å®š</h2>
        <p class="text-muted text-sm mb-6">AIæœ€é©åŒ–ã§è€ƒæ…®ã™ã‚‹ç”Ÿæ´»ãƒªã‚ºãƒ ã‚’è¨­å®š</p>

        <form action="/lifestyle/save" method="post">
            <input type="hidden" name="selected_playlist" value="{{ selected_id }}">

            <div class="form-row mb-4">
                <div class="form-group">
                    <label class="form-label">èµ·åºŠæ™‚é–“</label>
                    <input type="time" name="wake_time" value="{{ lifestyle.wake_time if lifestyle else '07:00' }}"
                        class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">å°±å¯æ™‚é–“</label>
                    <input type="time" name="sleep_time" value="{{ lifestyle.sleep_time if lifestyle else '23:00' }}"
                        class="form-input">
                </div>
            </div>

            <div class="form-row mb-4">
                <div class="form-group">
                    <label class="form-label">æœé£Ÿ</label>
                    <input type="time" name="breakfast_time"
                        value="{{ lifestyle.breakfast_time if lifestyle else '07:30' }}" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">æ˜¼é£Ÿ</label>
                    <input type="time" name="lunch_time" value="{{ lifestyle.lunch_time if lifestyle else '12:00' }}"
                        class="form-input">
                </div>
            </div>

            <div class="form-row mb-4">
                <div class="form-group">
                    <label class="form-label">å¤•é£Ÿ</label>
                    <input type="time" name="dinner_time" value="{{ lifestyle.dinner_time if lifestyle else '19:00' }}"
                        class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">å…¥æµ´</label>
                    <input type="time" name="bath_time" value="{{ lifestyle.bath_time if lifestyle else '21:00' }}"
                        class="form-input">
                </div>
            </div>

            <div class="flex gap-2 mt-6">
                <button type="submit" class="btn btn-success" style="flex: 1;">ğŸ’¾ ä¿å­˜</button>
                <button type="button" onclick="document.getElementById('lifestyle-dialog').classList.add('hidden')"
                    class="btn btn-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </form>
    </div>
</div>

<!-- ã‚¿ã‚¹ã‚¯ä½œæˆ -->
<div class="card">
    <h2 class="section-title">âœ¨ æ–°è¦ã‚¿ã‚¹ã‚¯ä½œæˆ</h2>

    <form action="/task/create" method="post">
        <input type="hidden" name="selected_playlist" value="{{ selected_id or '' }}">

        <div class="form-row mb-4">
            <div class="form-group">
                <input type="text" name="title" placeholder="ã‚¿ã‚¹ã‚¯å" required class="form-input">
            </div>
            <div class="form-group">
                <select name="difficulty" class="form-select">
                    <option value="1">â­ ç°¡å˜</option>
                    <option value="2" selected>â­â­ æ™®é€š</option>
                    <option value="3">â­â­â­ ä¸­ç¨‹åº¦</option>
                    <option value="4">â­â­â­â­ é›£ã—ã„</option>
                    <option value="5">â­â­â­â­â­ è¶…é›£</option>
                </select>
            </div>
        </div>

        <div class="form-row mb-4">
            <div class="form-group">
                <label class="form-label">ä½œæ¥­æ™‚é–“ï¼ˆåˆ†ï¼‰</label>
                <input type="number" name="duration" value="25" class="form-input">
            </div>
            <div class="form-group">
                <label class="form-label">ä¼‘æ†©æ™‚é–“ï¼ˆåˆ†ï¼‰</label>
                <input type="number" name="break_duration" value="5" class="form-input">
            </div>
        </div>

        <button type="submit" class="btn btn-primary">â• ã‚¿ã‚¹ã‚¯ä½œæˆ</button>
    </form>
</div>

<!-- åˆ©ç”¨å¯èƒ½ã‚¿ã‚¹ã‚¯ä¸€è¦§ -->
<div class="card">
    <h2 class="section-title">ğŸ“ åˆ©ç”¨å¯èƒ½ãªã‚¿ã‚¹ã‚¯</h2>
    <p class="text-muted text-sm mb-4">ï¼‹ãƒœã‚¿ãƒ³ã§ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã«è¿½åŠ </p>

    {% if pending_tasks|length == 0 %}
    <p class="text-muted">ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“</p>
    {% else %}
    {% for task in pending_tasks %}
    <div class="list-item">
        <span class="title">{{ task.title }}</span>
        <span class="meta">{{ task.duration }}åˆ† + {{ task.break_duration }}åˆ†ä¼‘æ†©</span>
        <span class="meta">{{ 'â­' * task.difficulty }}</span>
        <div class="actions">
            {% if selected_id %}
            <form action="/playlist/{{ selected_id }}/add/{{ task.id }}" method="post" style="display: inline;">
                <button type="submit" class="action-btn" style="color: #4caf50; font-size: 18px;">â•</button>
            </form>
            {% endif %}
            <form action="/task/{{ task.id }}/delete" method="post" style="display: inline;">
                <button type="submit" onclick="return confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')" class="action-btn"
                    style="color: #f44336;">ğŸ—‘ï¸</button>
            </form>
        </div>
    </div>
    {% endfor %}
    {% endif %}
</div>

<script>
    document.querySelectorAll('input[name="mode"]').forEach(radio => {
        radio.addEventListener('change', function () {
            const timeLimitInput = document.getElementById('time-limit-input');
            if (this.value === 'time_limited') {
                timeLimitInput.classList.remove('hidden');
            } else {
                timeLimitInput.classList.add('hidden');
            }
        });
    });

    // ãƒšãƒ¼ã‚¸è¡¨ç¤ºæ™‚ã«localStorageã«ä¿å­˜ï¼ˆã‚²ã‚¹ãƒˆç”¨ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼‰
    (async function () {
        try {
            const res = await fetch('/api/get-all-data');
            const data = await res.json();
            if (data.tasks) MoonTaskerStorage.saveTasks(data.tasks);
            if (data.playlists) MoonTaskerStorage.savePlaylists(data.playlists);
            console.log('ğŸ“¦ Data backed up to localStorage');
        } catch (e) { }
    })();
</script>
{% endblock %}