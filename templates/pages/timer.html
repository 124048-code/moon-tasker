{% extends 'base.html' %}

{% block title %}ã‚¿ã‚¤ãƒãƒ¼ - Moon Tasker{% endblock %}

{% block content %}
<h1 class="page-title">ã‚¿ã‚¤ãƒãƒ¼ â±ï¸</h1>

<!-- ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤º -->
<div class="card text-center" id="timer-card" style="padding: 48px 24px;">
    <p id="progress-text" style="color: #64b5f6; font-size: 18px; margin-bottom: 8px; font-weight: 500;"></p>
    <p id="timer-display" class="timer-display">00:00</p>
    <p id="status-text" style="font-size: 20px; margin-top: 16px; color: #ccc;">ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„</p>
    <p id="next-task-text" class="text-muted mt-2"></p>
    <p id="end-time-text" style="color: #ffc107; margin-top: 8px;"></p>
</div>

<!-- ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆé¸æŠ -->
<div class="card" id="playlist-selection">
    <h2 class="section-title">ğŸ“‹ ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆé¸æŠ</h2>
    <p class="text-muted text-sm mb-4">é¸æŠã—ãŸãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã®ã‚¿ã‚¹ã‚¯ã‚’é †ç•ªã«å®Ÿè¡Œã—ã¾ã™</p>

    <select id="playlist-dropdown" class="form-select mb-4">
        <option value="">ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚’é¸æŠ...</option>
        {% for playlist in playlists %}
        <option value="{{ playlist.id }}">{{ playlist.name }}</option>
        {% endfor %}
    </select>

    {% if playlists|length == 0 %}
    <div class="card text-center" style="background: rgba(255, 193, 7, 0.1); border-color: rgba(255, 193, 7, 0.3);">
        <span style="font-size: 48px;">ğŸ“</span>
        <p style="font-weight: 600; margin-top: 12px;">ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</p>
        <p class="text-muted text-sm mt-2">ã¾ãšãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚’ä½œæˆã—ã¾ã—ã‚‡ã†ï¼</p>
        <a href="/playlist" class="btn btn-warning mt-4">ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚’ä½œæˆ</a>
    </div>
    {% endif %}
</div>

<!-- ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¡¨ç¤º -->
<div class="card">
    <h2 class="section-title">ğŸ“… ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</h2>
    <div id="schedule-container">
        <p class="text-muted">ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚’é¸æŠã™ã‚‹ã¨è¡¨ç¤ºã•ã‚Œã¾ã™</p>
    </div>
</div>

<!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ -->
<div class="flex justify-center gap-4 mt-6" id="control-buttons">
    <button id="start-btn" onclick="startTimer()" class="btn btn-success" disabled
        style="padding: 16px 40px; font-size: 16px;">
        â–¶ï¸ é–‹å§‹
    </button>
    <button id="pause-btn" onclick="togglePause()" class="btn btn-secondary hidden" style="padding: 16px 32px;">
        â¸ï¸ ä¸€æ™‚åœæ­¢
    </button>
    <button id="stop-btn" onclick="confirmStop()" class="btn btn-danger hidden" style="padding: 16px 32px;">
        â¹ï¸ ä¸­æ­¢
    </button>
</div>

<!-- å®Œäº†ãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
<div id="complete-dialog" class="dialog-overlay hidden">
    <div class="card dialog-content text-center" style="padding: 40px;">
        <p style="font-size: 64px; margin-bottom: 16px;">ğŸ‰</p>
        <h2 class="page-title" style="margin-bottom: 16px;">é”æˆã—ã¾ã—ãŸï¼</h2>
        <p id="complete-message" style="font-size: 18px; margin-bottom: 24px;"></p>
        <button onclick="closeCompleteDialog()" class="btn btn-success">ğŸ  ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let timerState = {
        isRunning: false,
        isPaused: false,
        remainingSeconds: 0,
        currentTaskIndex: 0,
        tasks: [],
        isBreak: false,
        intervalId: null
    };

    const timerDisplay = document.getElementById('timer-display');
    const statusText = document.getElementById('status-text');
    const progressText = document.getElementById('progress-text');
    const nextTaskText = document.getElementById('next-task-text');
    const timerCard = document.getElementById('timer-card');
    const playlistDropdown = document.getElementById('playlist-dropdown');
    const startBtn = document.getElementById('start-btn');
    const pauseBtn = document.getElementById('pause-btn');
    const stopBtn = document.getElementById('stop-btn');
    const playlistSelection = document.getElementById('playlist-selection');

    playlistDropdown.addEventListener('change', async function () {
        const playlistId = this.value;
        if (!playlistId) {
            startBtn.disabled = true;
            return;
        }

        const response = await fetch(`/timer/playlist/${playlistId}/tasks`);
        const html = await response.text();
        document.getElementById('schedule-container').innerHTML = html;

        const tasksData = document.getElementById('tasks-data');
        if (tasksData) {
            timerState.tasks = JSON.parse(tasksData.textContent);
            startBtn.disabled = timerState.tasks.length === 0;
        }
    });

    function startTimer() {
        if (timerState.tasks.length === 0) return;
        timerState.isRunning = true;
        timerState.currentTaskIndex = 0;
        timerState.isBreak = false;
        playlistSelection.classList.add('hidden');
        startBtn.classList.add('hidden');
        pauseBtn.classList.remove('hidden');
        stopBtn.classList.remove('hidden');
        timerCard.classList.add('active');
        startTask();
    }

    function startTask() {
        if (timerState.currentTaskIndex >= timerState.tasks.length) {
            completePlaylist();
            return;
        }
        const task = timerState.tasks[timerState.currentTaskIndex];
        timerState.remainingSeconds = task.duration * 60;
        timerState.isBreak = false;
        progressText.textContent = `ã‚¿ã‚¹ã‚¯ ${timerState.currentTaskIndex + 1} / ${timerState.tasks.length}`;
        statusText.textContent = `ğŸ“ ${task.title}`;
        const nextTask = timerState.tasks[timerState.currentTaskIndex + 1];
        nextTaskText.textContent = nextTask ? `æ¬¡: ${nextTask.title}` : 'ğŸ¯ æœ€å¾Œã®ã‚¿ã‚¹ã‚¯ã§ã™ï¼';
        updateTimerDisplay();
        timerState.intervalId = setInterval(tick, 1000);
    }

    function startBreak() {
        const task = timerState.tasks[timerState.currentTaskIndex];
        timerState.remainingSeconds = task.break_duration * 60;
        timerState.isBreak = true;
        statusText.textContent = `â˜• ä¼‘æ†©ä¸­ (${task.break_duration}åˆ†)`;
        updateTimerDisplay();
        timerState.intervalId = setInterval(tick, 1000);
    }

    function tick() {
        if (!timerState.isRunning || timerState.isPaused) return;
        timerState.remainingSeconds--;
        updateTimerDisplay();
        if (timerState.remainingSeconds <= 0) {
            clearInterval(timerState.intervalId);
            if (timerState.isBreak) {
                timerState.currentTaskIndex++;
                startTask();
            } else {
                const task = timerState.tasks[timerState.currentTaskIndex];
                completeTask(task);
                if (task.break_duration > 0) {
                    startBreak();
                } else {
                    timerState.currentTaskIndex++;
                    startTask();
                }
            }
        }
    }

    function updateTimerDisplay() {
        const minutes = Math.floor(timerState.remainingSeconds / 60);
        const seconds = timerState.remainingSeconds % 60;
        timerDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    }

    function togglePause() {
        timerState.isPaused = !timerState.isPaused;
        pauseBtn.textContent = timerState.isPaused ? 'â–¶ï¸ å†é–‹' : 'â¸ï¸ ä¸€æ™‚åœæ­¢';
    }

    function confirmStop() {
        if (confirm('æœ¬å½“ã«ä¸­æ­¢ã—ã¾ã™ã‹ï¼Ÿ')) {
            stopTimer();
        }
    }

    function stopTimer() {
        timerState.isRunning = false;
        clearInterval(timerState.intervalId);
        resetUI();
    }

    async function completeTask(task) {
        await fetch('/timer/complete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `task_id=${task.id}&difficulty=${task.difficulty}`
        });
    }

    function completePlaylist() {
        timerState.isRunning = false;
        clearInterval(timerState.intervalId);
        document.getElementById('complete-message').textContent = `âœ¨ ${timerState.tasks.length}å€‹ã®ã‚¿ã‚¹ã‚¯ã‚’å®Œäº†ã—ã¾ã—ãŸï¼`;
        document.getElementById('complete-dialog').classList.remove('hidden');
    }

    function closeCompleteDialog() {
        document.getElementById('complete-dialog').classList.add('hidden');
        window.location.href = '/';
    }

    function resetUI() {
        timerDisplay.textContent = '00:00';
        progressText.textContent = '';
        nextTaskText.textContent = '';
        playlistSelection.classList.remove('hidden');
        startBtn.classList.remove('hidden');
        pauseBtn.classList.add('hidden');
        stopBtn.classList.add('hidden');
        timerCard.classList.remove('active');
        statusText.textContent = 'ä¸­æ­¢ã—ã¾ã—ãŸ';
    }

    {% if request.args.get('quick') %}
    window.onload = function () {
        timerState.tasks = [{ id: -1, title: 'ã‚¯ã‚¤ãƒƒã‚¯é›†ä¸­ã‚¿ã‚¤ãƒ ', duration: 25, break_duration: 5, difficulty: 3 }];
        startTimer();
    };
    {% endif %}
</script>
{% endblock %}