{% extends 'base.html' %}

{% block title %}ã‚¿ã‚¤ãƒãƒ¼ - Moon Tasker{% endblock %}

{% block content %}
<h1 class="page-title">ã‚¿ã‚¤ãƒãƒ¼ â±ï¸</h1>

<!-- ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤º -->
<div class="card text-center" id="timer-card" style="padding: 48px 24px;">
    <p id="progress-text" style="color: #64b5f6; font-size: 18px; margin-bottom: 8px; font-weight: 500;"></p>
    <p id="timer-display" class="timer-display">00:00</p>
    <p id="status-text" style="font-size: 20px; margin-top: 16px; color: #ccc;">ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„</p>
    <p id="next-task-text" class="text-muted mt-2"></p>
    <p id="end-time-text" style="color: #ffc107; margin-top: 8px;"></p>
</div>

<!-- ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆé¸æŠ -->
<div class="card" id="playlist-selection">
    <h2 class="section-title">ğŸ“‹ ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆé¸æŠ</h2>
    <p class="text-muted text-sm mb-4">é¸æŠã—ãŸãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã®ã‚¿ã‚¹ã‚¯ã‚’é †ç•ªã«å®Ÿè¡Œã—ã¾ã™</p>

    <select id="playlist-dropdown" class="form-select mb-4">
        <option value="">ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚’é¸æŠ...</option>
        {% for playlist in playlists %}
        <option value="{{ playlist.id }}">{{ playlist.name }}</option>
        {% endfor %}
    </select>

    {% if playlists|length == 0 %}
    <div class="card text-center" style="background: rgba(255, 193, 7, 0.1); border-color: rgba(255, 193, 7, 0.3);">
        <span style="font-size: 48px;">ğŸ“</span>
        <p style="font-weight: 600; margin-top: 12px;">ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</p>
        <p class="text-muted text-sm mt-2">ã¾ãšãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚’ä½œæˆã—ã¾ã—ã‚‡ã†ï¼</p>
        <a href="/playlist" class="btn btn-warning mt-4">ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚’ä½œæˆ</a>
    </div>
    {% endif %}
</div>

<!-- ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¡¨ç¤º -->
<div class="card">
    <h2 class="section-title">ğŸ“… ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</h2>
    <div id="schedule-container">
        <p class="text-muted">ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚’é¸æŠã™ã‚‹ã¨è¡¨ç¤ºã•ã‚Œã¾ã™</p>
    </div>
</div>

<!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ -->
<div class="flex justify-center gap-4 mt-6" id="control-buttons">
    <button id="start-btn" onclick="startTimer()" class="btn btn-success" disabled
        style="padding: 16px 40px; font-size: 16px;">
        â–¶ï¸ é–‹å§‹
    </button>

    <!-- ã‚¿ã‚¤ãƒãƒ¼å‹•ä½œä¸­ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
    <div id="timer-menu-container" class="hidden" style="position: relative;">
        <button onclick="toggleTimerMenu()" class="btn btn-secondary" style="padding: 16px 20px; opacity: 0.6;">
            â‹¯
        </button>
        <div id="timer-menu" class="hidden"
            style="position: absolute; bottom: 100%; right: 0; margin-bottom: 8px; background: rgba(30,30,50,0.95); border-radius: 12px; padding: 8px; min-width: 150px; box-shadow: 0 4px 20px rgba(0,0,0,0.5);">
            <button id="pause-btn" onclick="togglePause(); toggleTimerMenu();" class="btn btn-secondary w-full mb-2"
                style="padding: 12px;">
                â¸ï¸ ä¸€æ™‚åœæ­¢
            </button>
            <button id="stop-btn" onclick="showStopConfirm(); toggleTimerMenu();" class="btn btn-danger w-full"
                style="padding: 12px;">
                â¹ï¸ ä¸­æ­¢
            </button>
        </div>
    </div>
</div>

<!-- å®Œäº†ãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
<div id="complete-dialog" class="dialog-overlay hidden">
    <div class="card dialog-content text-center" style="padding: 40px;">
        <p style="font-size: 64px; margin-bottom: 16px;">ğŸ‰</p>
        <h2 class="page-title" style="margin-bottom: 16px;">ç´ æ™´ã‚‰ã—ã„ï¼</h2>
        <p id="complete-message" style="font-size: 18px; margin-bottom: 24px;"></p>

        <div id="motivation-message"
            style="background: linear-gradient(135deg, rgba(255, 193, 7, 0.1), rgba(255, 152, 0, 0.1)); padding: 16px; border-radius: 12px; margin-bottom: 24px;">
            <p style="font-size: 16px; color: #ffc107; font-weight: 500;">âœ¨ ã‚ãªãŸã®åŠªåŠ›ãŒå®Ÿã‚’çµã³ã¾ã—ãŸï¼<br>ã“ã®èª¿å­ã§å¤¢ã«å‘ã‹ã£ã¦é€²ã¿ã¾ã—ã‚‡ã†ï¼</p>
        </div>

        <!-- ãƒãƒƒã‚¸ç²å¾—æ™‚ã¯æ˜Ÿåº§å›³é‘‘ã§è¡¨ç¤ºã™ã‚‹ãŸã‚ã“ã“ã§ã¯éè¡¨ç¤º -->
        <div id="badges-earned" class="hidden mb-4">
            <p style="color: #ffc107;">ğŸŒŸ æ–°ã—ã„æ˜Ÿåº§ãŒè¼ãå§‹ã‚ã¾ã—ãŸï¼å›³é‘‘ã§ç¢ºèªã—ã‚ˆã†ï¼</p>
        </div>

        <!-- é€²åŒ–è¡¨ç¤º -->
        <div id="evolution-earned" class="hidden mb-4">
            <h3 style="color: #7c4dff; margin-bottom: 12px;">ğŸŒŸ é€²åŒ–ã—ã¾ã—ãŸï¼</h3>
            <div id="evolution-info"></div>
        </div>

        <!-- ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆè¡¨ç¤º -->
        <div id="present-earned" class="hidden mb-4">
            <h3 style="color: #ff6b9d; margin-bottom: 12px;">ğŸ ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆï¼</h3>
            <div id="present-info"></div>
        </div>

        <button onclick="closeCompleteDialog()" class="btn btn-success">ğŸ  ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</button>
    </div>
</div>

<!-- ä¸­æ­¢ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ï¼ˆ2æ®µéšè­¦å‘Šï¼‰ -->
<div id="stop-dialog" class="dialog-overlay hidden">
    <div class="card dialog-content text-center" style="padding: 32px; max-width: 400px;">
        <div id="stop-step1">
            <p style="font-size: 48px; margin-bottom: 16px;">ğŸ¥º</p>
            <h2 class="section-title">ã‚ã¨å°‘ã—ãªã®ã«â€¦</h2>
            <p class="text-muted mb-6">
                ã“ã“ã¾ã§é ‘å¼µã£ãŸã‚ãªãŸã®åŠªåŠ›ã€<br>
                ç„¡é§„ã«ã—ã¦ã—ã¾ã†ã‚“ã§ã™ã‹ï¼Ÿ
            </p>
            <div class="flex gap-2">
                <button onclick="showSecondWarning()" class="btn btn-danger" style="flex: 1;">ãã‚Œã§ã‚‚ã‚„ã‚ã‚‹</button>
                <button onclick="document.getElementById('stop-dialog').classList.add('hidden')" class="btn btn-success"
                    style="flex: 1;">ã‚‚ã†å°‘ã—é ‘å¼µã‚‹</button>
            </div>
        </div>
        <div id="stop-step2" class="hidden">
            <p style="font-size: 48px; margin-bottom: 16px;">ğŸ’”</p>
            <h2 class="section-title" style="color: #e91e63;">æœ¬å½“ã«ã„ã„ã®ï¼Ÿ</h2>
            <p class="mb-6" style="color: #ff9800; line-height: 1.8;">
                é€”ä¸­ã§è«¦ã‚ã‚‹ã¨ã€æ¬¡ã‚‚è«¦ã‚ã‚„ã™ããªã‚Šã¾ã™ã€‚<br><br>
                <span style="color: #aaa; font-size: 14px;">
                    ã€Œä»Šæ—¥ã ã‘ã€ã®ã¤ã‚‚ã‚ŠãŒã€<br>
                    ã„ã¤ã®é–“ã«ã‹ç¿’æ…£ã«ãªã£ã¦ã—ã¾ã†ã‹ã‚‚â€¦<br><br>
                </span>
                {% if has_creature %}
                <span style="color: #e91e63; font-weight: 600; font-size: 15px;">
                    ğŸ¾ ã‚ãªãŸã®ç”Ÿå‘½ä½“ã‚‚æ‚²ã—ã‚“ã§ã„ã¾ã™â€¦<br>
                </span>
                {% endif %}
                <span style="color: #ccc; font-size: 13px;">
                    ã‚ãªãŸãªã‚‰ã§ãã‚‹ã¯ãšã€‚
                </span>
            </p>
            <div class="flex gap-2">
                <button onclick="actuallyStop()" class="btn btn-danger" style="flex: 1;">â€¦ã‚„ã‚ã‚‹</button>
                <button
                    onclick="document.getElementById('stop-dialog').classList.add('hidden'); document.getElementById('stop-step1').classList.remove('hidden'); document.getElementById('stop-step2').classList.add('hidden');"
                    class="btn btn-success" style="flex: 1;">ã‚„ã£ã±ã‚Šé ‘å¼µã‚‹ï¼</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let timerState = {
        isRunning: false,
        isPaused: false,
        remainingSeconds: 0,
        currentTaskIndex: 0,
        tasks: [],
        isBreak: false,
        intervalId: null
    };

    const timerDisplay = document.getElementById('timer-display');
    const statusText = document.getElementById('status-text');
    const progressText = document.getElementById('progress-text');
    const nextTaskText = document.getElementById('next-task-text');
    const timerCard = document.getElementById('timer-card');
    const playlistDropdown = document.getElementById('playlist-dropdown');
    const startBtn = document.getElementById('start-btn');
    const pauseBtn = document.getElementById('pause-btn');
    const stopBtn = document.getElementById('stop-btn');
    const playlistSelection = document.getElementById('playlist-selection');

    playlistDropdown.addEventListener('change', async function () {
        const playlistId = this.value;
        if (!playlistId) {
            startBtn.disabled = true;
            return;
        }

        const response = await fetch(`/timer/playlist/${playlistId}/tasks`);
        const html = await response.text();
        document.getElementById('schedule-container').innerHTML = html;

        const tasksData = document.getElementById('tasks-data');
        if (tasksData) {
            timerState.tasks = JSON.parse(tasksData.textContent);
            startBtn.disabled = timerState.tasks.length === 0;
        }
    });

    function startTimer() {
        if (timerState.tasks.length === 0) return;
        timerState.isRunning = true;
        timerState.currentTaskIndex = 0;
        timerState.isBreak = false;
        playlistSelection.classList.add('hidden');
        startBtn.classList.add('hidden');
        document.getElementById('timer-menu-container').classList.remove('hidden');
        timerCard.classList.add('timer-active');

        // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤ºï¼ˆé›†ä¸­ãƒ¢ãƒ¼ãƒ‰ï¼‰
        const sidebar = document.querySelector('.sidebar');
        if (sidebar) sidebar.style.display = 'none';
        document.body.classList.add('focus-mode');

        startTask();
    }

    function startTask() {
        if (timerState.currentTaskIndex >= timerState.tasks.length) {
            completePlaylist();
            return;
        }
        const task = timerState.tasks[timerState.currentTaskIndex];
        timerState.remainingSeconds = task.duration * 60;
        timerState.isBreak = false;
        progressText.textContent = `ã‚¿ã‚¹ã‚¯ ${timerState.currentTaskIndex + 1} / ${timerState.tasks.length}`;
        statusText.textContent = `ğŸ“ ${task.title}`;
        const nextTask = timerState.tasks[timerState.currentTaskIndex + 1];
        nextTaskText.textContent = nextTask ? `æ¬¡: ${nextTask.title}` : 'ğŸ¯ æœ€å¾Œã®ã‚¿ã‚¹ã‚¯ã§ã™ï¼';
        updateTimerDisplay();
        timerState.intervalId = setInterval(tick, 1000);
    }

    function startBreak() {
        const task = timerState.tasks[timerState.currentTaskIndex];
        timerState.remainingSeconds = task.break_duration * 60;
        timerState.isBreak = true;
        statusText.textContent = `â˜• ä¼‘æ†©ä¸­ (${task.break_duration}åˆ†)`;
        updateTimerDisplay();
        timerState.intervalId = setInterval(tick, 1000);
    }

    async function tick() {
        if (!timerState.isRunning || timerState.isPaused) return;
        timerState.remainingSeconds--;
        updateTimerDisplay();
        if (timerState.remainingSeconds <= 0) {
            clearInterval(timerState.intervalId);
            if (timerState.isBreak) {
                timerState.currentTaskIndex++;
                startTask();
            } else {
                const task = timerState.tasks[timerState.currentTaskIndex];
                await completeTask(task);

                // æœ€å¾Œã®ã‚¿ã‚¹ã‚¯ã®å ´åˆã¯ä¼‘æ†©ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ã™ãã«å®Œäº†
                const isLastTask = timerState.currentTaskIndex >= timerState.tasks.length - 1;

                if (isLastTask) {
                    // æœ€å¾Œã®ã‚¿ã‚¹ã‚¯ãªã®ã§ä¼‘æ†©ãªã—ã§å®Œäº†
                    timerState.currentTaskIndex++;
                    completePlaylist();
                } else if (task.break_duration > 0) {
                    startBreak();
                } else {
                    timerState.currentTaskIndex++;
                    startTask();
                }
            }
        }
    }

    function updateTimerDisplay() {
        const minutes = Math.floor(timerState.remainingSeconds / 60);
        const seconds = timerState.remainingSeconds % 60;
        timerDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    }

    function togglePause() {
        timerState.isPaused = !timerState.isPaused;
        pauseBtn.textContent = timerState.isPaused ? 'â–¶ï¸ å†é–‹' : 'â¸ï¸ ä¸€æ™‚åœæ­¢';
    }

    function showStopConfirm() {
        document.getElementById('stop-dialog').classList.remove('hidden');
    }

    function showSecondWarning() {
        document.getElementById('stop-step1').classList.add('hidden');
        document.getElementById('stop-step2').classList.remove('hidden');
    }

    async function actuallyStop() {
        timerState.isRunning = false;
        clearInterval(timerState.intervalId);

        // ã‚µãƒ¼ãƒãƒ¼ã«ä¸­æ­¢ã‚’é€šçŸ¥ï¼ˆç”Ÿå‘½ä½“ã®æ©Ÿå«ŒãŒä¸‹ãŒã‚‹ï¼‰
        await fetch('/timer/abort', { method: 'POST' });

        document.getElementById('stop-dialog').classList.add('hidden');
        document.getElementById('stop-step1').classList.remove('hidden');
        document.getElementById('stop-step2').classList.add('hidden');
        resetUI();
    }

    let completedResults = { badges: [], evolutions: [], present: null };

    async function completeTask(task) {
        const response = await fetch('/timer/complete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `task_id=${task.id}&duration=${task.duration}`
        });
        const result = await response.json();

        // çµæœã‚’è“„ç©
        if (result.badges) completedResults.badges.push(...result.badges);
        if (result.evolutions) completedResults.evolutions.push(...result.evolutions);
        if (result.present) completedResults.present = result.present;
    }

    function completePlaylist() {
        timerState.isRunning = false;
        clearInterval(timerState.intervalId);

        document.getElementById('complete-message').textContent =
            `âœ¨ ${timerState.tasks.length}å€‹ã®ã‚¿ã‚¹ã‚¯ã‚’å®Œäº†ã—ã¾ã—ãŸï¼`;

        // ãƒãƒƒã‚¸è¡¨ç¤º
        if (completedResults.badges.length > 0) {
            document.getElementById('badges-earned').classList.remove('hidden');
            document.getElementById('badges-list').innerHTML = completedResults.badges
                .map(b => `<p style="color: #ffc107;">â­ ${b.name} (${b.constellation})</p>`).join('');
        }

        // é€²åŒ–è¡¨ç¤º
        if (completedResults.evolutions.length > 0) {
            document.getElementById('evolution-earned').classList.remove('hidden');
            document.getElementById('evolution-info').innerHTML = completedResults.evolutions
                .map(e => `<p style="color: #7c4dff;">Lv.${e.from} â†’ Lv.${e.to} ${e.name}ã«é€²åŒ–ï¼</p>`).join('');
        }

        // ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆè¡¨ç¤º
        if (completedResults.present) {
            document.getElementById('present-earned').classList.remove('hidden');
            document.getElementById('present-info').innerHTML =
                `<p>${completedResults.present.emoji} ${completedResults.present.name}</p>
             <p class="text-muted text-sm">${completedResults.present.desc}</p>`;
        }

        document.getElementById('complete-dialog').classList.remove('hidden');
    }

    function closeCompleteDialog() {
        document.getElementById('complete-dialog').classList.add('hidden');

        // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å†è¡¨ç¤º
        const sidebar = document.querySelector('.sidebar');
        if (sidebar) sidebar.style.display = '';
        document.body.classList.remove('focus-mode');

        window.location.href = '/';
    }

    function resetUI() {
        timerDisplay.textContent = '00:00';
        progressText.textContent = '';
        nextTaskText.textContent = '';
        playlistSelection.classList.remove('hidden');
        startBtn.classList.remove('hidden');
        document.getElementById('timer-menu-container').classList.add('hidden');
        document.getElementById('timer-menu').classList.add('hidden');
        timerCard.classList.remove('timer-active');
        statusText.textContent = 'ä¸­æ­¢ã—ã¾ã—ãŸ';
        completedResults = { badges: [], evolutions: [], present: null };

        // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å†è¡¨ç¤ºï¼ˆé›†ä¸­ãƒ¢ãƒ¼ãƒ‰è§£é™¤ï¼‰
        const sidebar = document.querySelector('.sidebar');
        if (sidebar) sidebar.style.display = '';
        document.body.classList.remove('focus-mode');
    }

    function toggleTimerMenu() {
        const menu = document.getElementById('timer-menu');
        menu.classList.toggle('hidden');
    }

    {% if request.args.get('quick') %}
    window.onload = function () {
        timerState.tasks = [{ id: -1, title: 'ã‚¯ã‚¤ãƒƒã‚¯é›†ä¸­ã‚¿ã‚¤ãƒ ', duration: 25, break_duration: 5, difficulty: 3 }];
        startTimer();
    };
    {% endif %}
</script>
{% endblock %}