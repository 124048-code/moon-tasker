<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Moon Tasker{% endblock %}</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Kaku+Gothic+New:wght@400;500;700&display=swap"
        rel="stylesheet">

    <!-- Main Stylesheet -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>

    {% block head %}{% endblock %}
</head>

<body>
    <div class="app-container">
        <!-- ã‚µã‚¤ãƒ‰ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
        <nav class="sidebar">
            <div class="sidebar-logo">
                <span>ğŸŒ™</span>
                <p>Moon Tasker</p>
            </div>

            <div class="nav-links">
                <a href="/" class="nav-link {% if request.endpoint == 'home' %}active{% endif %}">
                    <span class="icon">ğŸ </span>
                    <span class="label">ãƒ›ãƒ¼ãƒ </span>
                </a>

                <a href="/timer" class="nav-link {% if request.endpoint == 'timer' %}active{% endif %}">
                    <span class="icon">â±ï¸</span>
                    <span class="label">ã‚¿ã‚¤ãƒãƒ¼</span>
                </a>

                <a href="/playlist" class="nav-link {% if request.endpoint == 'playlist' %}active{% endif %}">
                    <span class="icon">ğŸ“</span>
                    <span class="label">ã‚¿ã‚¹ã‚¯</span>
                </a>

                <a href="/moon-cycle" class="nav-link {% if request.endpoint == 'moon_cycle' %}active{% endif %}">
                    <span class="icon">ğŸ¯</span>
                    <span class="label">ç›®æ¨™</span>
                </a>

                <a href="/collection" class="nav-link {% if request.endpoint == 'collection' %}active{% endif %}">
                    <span class="icon">â­</span>
                    <span class="label">å›³é‘‘</span>
                </a>

                <a href="/creature" class="nav-link {% if request.endpoint == 'creature' %}active{% endif %}">
                    <span class="icon">ğŸ¾</span>
                    <span class="label">ç”Ÿå‘½ä½“</span>
                </a>

                <a href="/friends" class="nav-link {% if request.endpoint == 'friends' %}active{% endif %}">
                    <span class="icon">ğŸ‘¥</span>
                    <span class="label">ãƒ•ãƒ¬ãƒ³ãƒ‰</span>
                </a>
            </div>
        </nav>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <main class="main-content">
            <div class="content-wrapper">
                {% block content %}{% endblock %}
            </div>
        </main>
    </div>

    {% block scripts %}{% endblock %}

    <!-- localStorage ãƒ‡ãƒ¼ã‚¿ç®¡ç† -->
    <script>
        const MoonTaskerStorage = {
            // ã‚­ãƒ¼å
            TASKS_KEY: 'moontasker_tasks',
            PLAYLISTS_KEY: 'moontasker_playlists',

            // ã‚¿ã‚¹ã‚¯ã‚’ä¿å­˜
            saveTasks(tasks) {
                localStorage.setItem(this.TASKS_KEY, JSON.stringify(tasks));
            },

            // ã‚¿ã‚¹ã‚¯ã‚’å–å¾—
            getTasks() {
                try {
                    return JSON.parse(localStorage.getItem(this.TASKS_KEY)) || [];
                } catch { return []; }
            },

            // ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚’ä¿å­˜
            savePlaylists(playlists) {
                localStorage.setItem(this.PLAYLISTS_KEY, JSON.stringify(playlists));
            },

            // ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚’å–å¾—
            getPlaylists() {
                try {
                    return JSON.parse(localStorage.getItem(this.PLAYLISTS_KEY)) || [];
                } catch { return []; }
            },

            // å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
            clear() {
                localStorage.removeItem(this.TASKS_KEY);
                localStorage.removeItem(this.PLAYLISTS_KEY);
            }
        };

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«localStorageã‹ã‚‰ã‚µãƒ¼ãƒãƒ¼ã«å¾©å…ƒ
        document.addEventListener('DOMContentLoaded', async function () {
            const tasks = MoonTaskerStorage.getTasks();
            const playlists = MoonTaskerStorage.getPlaylists();

            // ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°ã‚µãƒ¼ãƒãƒ¼ã«å¾©å…ƒï¼ˆåˆå›ã®ã¿ï¼‰
            if ((tasks.length > 0 || playlists.length > 0) && !sessionStorage.getItem('data_restored')) {
                try {
                    await fetch('/api/restore-local', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ tasks, playlists })
                    });
                    sessionStorage.setItem('data_restored', 'true');
                } catch (e) {
                    console.log('Data restore skipped');
                }
            }
        });
    </script>
</body>

</html>